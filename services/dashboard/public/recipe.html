<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OASIS Recipes</title>
<style>
  :root {
    --bg: #0a0e17;
    --surface: #131926;
    --surface2: #1a2235;
    --border: #253048;
    --text: #e0e6f0;
    --text-dim: #7a8ba8;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #eab308;
    --orange: #f97316;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    background: var(--bg); color: var(--text); min-height: 100vh;
  }

  /* Header */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 1rem;
    position: sticky; top: 0; z-index: 50; height: 50px;
  }
  header h1 { font-size: 1.1rem; font-weight: 600; color: var(--accent); letter-spacing: 0.1em; }
  header a {
    color: var(--text-dim); text-decoration: none; font-size: 0.75rem;
    transition: color 0.2s;
  }
  header a:hover { color: var(--accent); }
  .header-spacer { flex: 1; }
  .week-select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 0.35rem 0.6rem; color: var(--text); font-family: inherit;
    font-size: 0.75rem; outline: none; cursor: pointer;
  }
  .week-select:focus { border-color: var(--accent); }

  /* Day Navigation */
  .day-nav {
    display: flex; gap: 0.5rem; padding: 1rem 1.5rem; overflow-x: auto;
    border-bottom: 1px solid var(--border); background: var(--surface);
  }
  .day-card {
    flex: 1; min-width: 120px; padding: 0.6rem 0.75rem;
    background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .day-card:hover { border-color: var(--accent); background: rgba(0,212,255,0.03); }
  .day-card.active { border-color: var(--accent); background: rgba(0,212,255,0.06); }
  .day-card.today { box-shadow: inset 0 -2px 0 var(--accent); }
  .day-card .day-name {
    font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
    color: var(--text-dim); margin-bottom: 0.25rem;
  }
  .day-card.active .day-name { color: var(--accent); }
  .day-card .day-title {
    font-size: 0.68rem; color: var(--text); line-height: 1.3;
    overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  }
  .day-card .day-time {
    font-size: 0.6rem; color: var(--text-dim); margin-top: 0.2rem;
  }
  .day-card .no-recipe { font-size: 0.65rem; color: var(--text-dim); font-style: italic; }

  /* Recipe Content */
  .recipe-container {
    max-width: 800px; margin: 0 auto; padding: 1.5rem;
  }
  .recipe-loading {
    text-align: center; padding: 4rem 1rem; color: var(--text-dim); font-size: 0.85rem;
  }
  .recipe-empty {
    text-align: center; padding: 4rem 1rem; color: var(--text-dim);
  }
  .recipe-empty .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
  .recipe-empty .msg { font-size: 0.85rem; }
  .recipe-empty .hint { font-size: 0.72rem; margin-top: 0.5rem; opacity: 0.6; }

  /* Rendered Markdown */
  .recipe-content h1 { font-size: 1.3rem; margin: 0.5rem 0 0.8rem; color: var(--accent); }
  .recipe-content h2 { font-size: 1.05rem; margin: 1.2rem 0 0.5rem; color: var(--text); border-bottom: 1px solid var(--border); padding-bottom: 0.3rem; }
  .recipe-content h3 { font-size: 0.9rem; margin: 0.8rem 0 0.3rem; color: var(--text); }
  .recipe-content h4 { font-size: 0.82rem; margin: 0.6rem 0 0.25rem; color: var(--text-dim); }
  .recipe-content p { margin: 0.5rem 0; font-size: 0.82rem; line-height: 1.7; }
  .recipe-content ul, .recipe-content ol { margin: 0.4rem 0; padding-left: 1.5rem; }
  .recipe-content li { margin: 0.2rem 0; font-size: 0.82rem; line-height: 1.6; }
  .recipe-content code { background: var(--surface2); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.75rem; }
  .recipe-content pre { background: var(--surface2); padding: 0.75rem 1rem; border-radius: 8px; margin: 0.6rem 0; overflow-x: auto; font-size: 0.75rem; line-height: 1.5; }
  .recipe-content pre code { background: none; padding: 0; }
  .recipe-content a { color: var(--accent); }
  .recipe-content blockquote { border-left: 3px solid var(--accent); padding-left: 0.75rem; color: var(--text-dim); margin: 0.5rem 0; }
  .recipe-content strong { color: var(--text); }
  .recipe-content hr { border: none; border-top: 1px solid var(--border); margin: 1rem 0; }
  .recipe-content table { width: 100%; border-collapse: collapse; margin: 0.6rem 0; font-size: 0.78rem; }
  .recipe-content th { background: var(--surface2); padding: 0.4rem 0.6rem; text-align: left; border: 1px solid var(--border); font-weight: 600; color: var(--accent); }
  .recipe-content td { padding: 0.35rem 0.6rem; border: 1px solid var(--border); }
  .recipe-content tr:nth-child(even) td { background: rgba(19,25,38,0.5); }

  /* Info badges */
  .recipe-meta {
    display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;
  }
  .meta-badge {
    display: inline-flex; align-items: center; gap: 0.3rem;
    padding: 0.25rem 0.6rem; border-radius: 6px; font-size: 0.7rem;
    background: var(--surface2); border: 1px solid var(--border); color: var(--text-dim);
  }

  /* Mobile */
  @media (max-width: 768px) {
    .day-nav { padding: 0.75rem; gap: 0.35rem; }
    .day-card { min-width: 90px; padding: 0.45rem 0.5rem; }
    .day-card .day-title { font-size: 0.6rem; }
    .recipe-container { padding: 1rem; }
    .recipe-content h1 { font-size: 1.1rem; }
    header { padding: 0.5rem 1rem; }
  }
</style>
</head>
<body>

<header>
  <a href="/">&#8592; Dashboard</a>
  <h1>OASIS <span>Recipes</span></h1>
  <div class="header-spacer"></div>
  <select id="week-select" class="week-select"></select>
</header>

<div class="day-nav" id="day-nav"></div>

<div class="recipe-container">
  <div id="recipe-area">
    <div class="recipe-loading">Loading recipes...</div>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const DAYS = ["sunday","monday","tuesday","wednesday","thursday","friday","saturday"];
const DAY_LABELS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

let currentWeek = null;
let currentDay = null;
let weeksData = [];
let daysData = [];

function escapeHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function fetchJSON(url) {
  try { return await (await fetch(url)).json(); } catch { return null; }
}

function renderMd(text) {
  const lines = text.split('\n');
  let html = '';
  let inCode = false;
  let inList = false;
  let listType = '';
  let inTable = false;
  let tableRows = [];

  function flushTable() {
    if (!inTable || tableRows.length === 0) return;
    html += '<table>';
    for (let i = 0; i < tableRows.length; i++) {
      if (i === 1 && /^[\s|:-]+$/.test(tableRows[i].replace(/\|/g, '').replace(/-/g, '').replace(/:/g, '').trim())) continue;
      const tag = i === 0 ? 'th' : 'td';
      const cells = tableRows[i].split('|').map(c => c.trim()).filter(c => c !== '');
      html += '<tr>' + cells.map(c => {
        let s = escapeHtml(c);
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        return `<${tag}>${s}</${tag}>`;
      }).join('') + '</tr>';
    }
    html += '</table>';
    inTable = false;
    tableRows = [];
  }

  for (const line of lines) {
    // Code blocks
    if (line.startsWith('```')) {
      flushTable();
      if (inCode) { html += '</code></pre>'; inCode = false; }
      else { if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; } html += '<pre><code>'; inCode = true; }
      continue;
    }
    if (inCode) { html += escapeHtml(line) + '\n'; continue; }

    // Table rows
    if (line.includes('|') && line.trim().startsWith('|')) {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
      inTable = true;
      tableRows.push(line.trim());
      continue;
    } else {
      flushTable();
    }

    let s = escapeHtml(line);
    s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');

    if (/^#{1,6} /.test(line)) {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
      const lvl = line.match(/^(#{1,6})/)[1].length;
      html += `<h${lvl}>${s.replace(/^#{1,6} /, '')}</h${lvl}>`;
    } else if (line.startsWith('> ')) {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
      html += `<blockquote>${s.replace(/^&gt; /, '')}</blockquote>`;
    } else if (line === '---' || line === '***') {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
      html += '<hr>';
    } else if (/^[-*] /.test(line)) {
      if (!inList || listType !== 'ul') { if (inList) html += listType === 'ol' ? '</ol>' : '</ul>'; html += '<ul>'; inList = true; listType = 'ul'; }
      html += `<li>${s.replace(/^[-*] /, '')}</li>`;
    } else if (/^\d+\. /.test(line)) {
      if (!inList || listType !== 'ol') { if (inList) html += listType === 'ol' ? '</ol>' : '</ul>'; html += '<ol>'; inList = true; listType = 'ol'; }
      html += `<li>${s.replace(/^\d+\. /, '')}</li>`;
    } else if (line.trim() === '') {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
    } else {
      if (inList) { html += listType === 'ol' ? '</ol>' : '</ul>'; inList = false; }
      html += `<p>${s}</p>`;
    }
  }
  if (inCode) html += '</code></pre>';
  if (inList) html += listType === 'ol' ? '</ol>' : '</ul>';
  flushTable();
  return html;
}

function getTodayDay() {
  return DAYS[new Date().getDay()];
}

function getCurrentWeek() {
  const now = new Date();
  const jan1 = new Date(now.getFullYear(), 0, 1);
  const dayOfYear = Math.floor((now - jan1) / 86400000) + 1;
  const weekNum = Math.ceil((dayOfYear + jan1.getDay()) / 7);
  return `${now.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
}

function renderDayNav() {
  const nav = $('#day-nav');
  const today = getTodayDay();
  nav.innerHTML = DAYS.map((day, i) => {
    const info = daysData.find(d => d.day === day);
    const isActive = day === currentDay;
    const isToday = day === today;
    const classes = ['day-card', isActive ? 'active' : '', isToday ? 'today' : ''].filter(Boolean).join(' ');
    if (info && info.exists) {
      return `<div class="${classes}" data-day="${day}">
        <div class="day-name">${DAY_LABELS[i]}</div>
        <div class="day-title">${escapeHtml(info.title)}</div>
        ${info.cookTime ? `<div class="day-time">${escapeHtml(info.cookTime)}</div>` : ''}
      </div>`;
    }
    return `<div class="${classes}" data-day="${day}">
      <div class="day-name">${DAY_LABELS[i]}</div>
      <div class="no-recipe">No recipe</div>
    </div>`;
  }).join('');

  nav.querySelectorAll('.day-card').forEach(card => {
    card.addEventListener('click', () => {
      currentDay = card.dataset.day;
      const url = new URL(window.location);
      url.searchParams.set('day', currentDay);
      history.replaceState(null, '', url);
      renderDayNav();
      loadRecipe();
    });
  });
}

async function loadRecipe() {
  const area = $('#recipe-area');
  if (!currentWeek || !currentDay) {
    area.innerHTML = '<div class="recipe-empty"><div class="icon">&#127869;</div><div class="msg">Select a day to view the recipe</div></div>';
    return;
  }
  area.innerHTML = '<div class="recipe-loading">Loading recipe...</div>';
  const data = await fetchJSON(`/api/recipes/${currentWeek}/${currentDay}`);
  if (!data || data.error || !data.content) {
    area.innerHTML = `<div class="recipe-empty"><div class="icon">&#128203;</div><div class="msg">No recipe for ${currentDay}</div><div class="hint">Recipes are generated with the weekly meal plan on Sunday mornings</div></div>`;
    return;
  }
  area.innerHTML = `<div class="recipe-content">${renderMd(data.content)}</div>`;
}

async function loadWeek(week) {
  currentWeek = week;
  const url = new URL(window.location);
  url.searchParams.set('week', week);
  history.replaceState(null, '', url);

  const data = await fetchJSON(`/api/recipes/${week}`);
  daysData = data?.days || [];
  renderDayNav();
  loadRecipe();
}

async function init() {
  const params = new URLSearchParams(window.location.search);
  const urlWeek = params.get('week');
  const urlDay = params.get('day');

  // Load available weeks
  const weeksRes = await fetchJSON('/api/recipes/weeks');
  weeksData = weeksRes?.weeks || [];

  const select = $('#week-select');
  if (weeksData.length === 0) {
    select.innerHTML = '<option value="">No recipes yet</option>';
    $('#day-nav').innerHTML = '';
    $('#recipe-area').innerHTML = '<div class="recipe-empty"><div class="icon">&#127869;</div><div class="msg">No recipes generated yet</div><div class="hint">The weekly meal plan cron generates recipes every Sunday at 9 AM</div></div>';
    return;
  }

  select.innerHTML = weeksData.map(w => `<option value="${w}">${w}</option>`).join('');

  // Determine starting week
  const startWeek = urlWeek && weeksData.includes(urlWeek) ? urlWeek : weeksData[0];
  select.value = startWeek;

  // Determine starting day
  currentDay = urlDay && DAYS.includes(urlDay) ? urlDay : getTodayDay();

  select.addEventListener('change', () => loadWeek(select.value));
  await loadWeek(startWeek);
}

init();
</script>
</body>
</html>
