<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OASIS Dashboard</title>
<style>
  :root {
    --bg: #0a0e17;
    --surface: #131926;
    --surface2: #1a2235;
    --border: #253048;
    --text: #e0e6f0;
    --text-dim: #7a8ba8;
    --accent: #00d4ff;
    --accent2: #7c3aed;
    --green: #22c55e;
    --red: #ef4444;
    --yellow: #eab308;
    --orange: #f97316;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
    background: var(--bg); color: var(--text); min-height: 100vh;
  }

  /* === Header === */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 1rem;
    position: sticky; top: 0; z-index: 50; height: 50px;
  }
  header h1 { font-size: 1.1rem; font-weight: 600; color: var(--accent); letter-spacing: 0.1em; white-space: nowrap; }
  header h1 span { color: var(--text-dim); font-weight: 400; }
  .header-spacer { flex: 1; }
  .search-container { position: relative; }
  .search-input {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 0.35rem 0.7rem 0.35rem 1.8rem; color: var(--text); font-family: inherit;
    font-size: 0.75rem; width: 220px; outline: none; transition: border-color 0.2s, width 0.2s;
  }
  .search-input:focus { border-color: var(--accent); width: 300px; }
  .search-input::placeholder { color: var(--text-dim); opacity: 0.5; }
  .search-icon { position: absolute; left: 0.55rem; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 0.75rem; pointer-events: none; }
  /* === Knowledge Base Modal === */
  #kb-modal .modal-content {
    max-width: 1050px; width: 95vw; height: 85vh; max-height: 85vh;
    display: flex; flex-direction: column;
  }
  .kb-search-row {
    padding: 0.5rem 1.25rem; border-bottom: 1px solid var(--border);
    display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0;
  }
  .kb-search-row input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 0.45rem 0.75rem; color: var(--text); font-family: inherit; font-size: 0.82rem; outline: none;
  }
  .kb-search-row input:focus { border-color: var(--accent); }
  .kb-search-row input::placeholder { color: var(--text-dim); opacity: 0.5; }
  .kb-back-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.65rem; color: var(--text-dim); font-family: inherit;
    font-size: 0.72rem; cursor: pointer; white-space: nowrap; transition: all 0.15s;
  }
  .kb-back-btn:hover { color: var(--accent); border-color: var(--accent); }
  .kb-results-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem; padding: 1rem 1.25rem;
  }
  .kb-result-card {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 10px;
    padding: 0.75rem; cursor: pointer; transition: border-color 0.15s, background 0.15s;
  }
  .kb-result-card:hover { border-color: var(--accent); background: rgba(0,212,255,0.03); }
  .kb-result-card .file-name {
    font-weight: 600; font-size: 0.8rem; color: var(--accent);
    margin-bottom: 0.25rem; word-break: break-word;
  }
  .kb-result-card .category {
    display: inline-block; padding: 0.05rem 0.35rem; border-radius: 3px;
    font-size: 0.6rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.35rem;
    background: rgba(0,212,255,0.1); color: var(--accent);
  }
  .kb-result-card .category.transcripts { background: rgba(124,58,237,0.15); color: var(--accent2); }
  .kb-result-card .category.profiles { background: rgba(34,197,94,0.15); color: var(--green); }
  .kb-result-card .category.logs { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .kb-result-card .match-count { font-size: 0.62rem; color: var(--text-dim); margin-bottom: 0.35rem; }
  .kb-result-card .snippet {
    font-size: 0.7rem; color: var(--text-dim); line-height: 1.4;
    overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
  }
  .kb-empty {
    padding: 3rem 1rem; text-align: center; color: var(--text-dim);
    font-size: 0.82rem; grid-column: 1 / -1;
  }
  .kb-empty .hint { font-size: 0.72rem; margin-top: 0.5rem; opacity: 0.6; }
  #kb-body { overflow: hidden; display: flex; flex-direction: column; }
  #kb-results { flex: 1; overflow-y: auto; }
  #kb-doc-view { flex: 1; overflow: hidden; }
  .kb-doc-container { display: flex; height: 100%; overflow: hidden; }
  .kb-doc-panel {
    flex: 3; overflow-y: auto; padding: 1rem 1.25rem;
    border-right: 1px solid var(--border); font-size: 0.8rem; line-height: 1.7;
  }
  .kb-doc-panel h1 { font-size: 1.1rem; margin: 0.8rem 0 0.4rem; color: var(--accent); }
  .kb-doc-panel h2 { font-size: 0.95rem; margin: 0.7rem 0 0.3rem; color: var(--text); border-bottom: 1px solid var(--border); padding-bottom: 0.2rem; }
  .kb-doc-panel h3 { font-size: 0.85rem; margin: 0.6rem 0 0.25rem; color: var(--text); }
  .kb-doc-panel h4 { font-size: 0.8rem; margin: 0.5rem 0 0.2rem; color: var(--text-dim); }
  .kb-doc-panel p { margin: 0.4rem 0; }
  .kb-doc-panel ul, .kb-doc-panel ol { margin: 0.3rem 0; padding-left: 1.5rem; }
  .kb-doc-panel li { margin: 0.15rem 0; }
  .kb-doc-panel code { background: var(--bg); padding: 0.1rem 0.3rem; border-radius: 3px; font-size: 0.75rem; }
  .kb-doc-panel pre { background: var(--bg); padding: 0.6rem 0.8rem; border-radius: 6px; margin: 0.5rem 0; overflow-x: auto; font-size: 0.72rem; line-height: 1.5; }
  .kb-doc-panel pre code { background: none; padding: 0; }
  .kb-doc-panel a { color: var(--accent); }
  .kb-doc-panel blockquote { border-left: 3px solid var(--accent); padding-left: 0.75rem; color: var(--text-dim); margin: 0.4rem 0; }
  .kb-doc-panel strong { color: var(--text); }
  .kb-doc-panel hr { border: none; border-top: 1px solid var(--border); margin: 0.75rem 0; }
  .kb-chat-panel { flex: 2; display: flex; flex-direction: column; min-width: 0; }
  .kb-chat-header {
    padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border);
    font-size: 0.72rem; color: var(--text-dim); font-weight: 500;
    display: flex; align-items: center; gap: 0.4rem; flex-shrink: 0;
  }
  .kb-chat-header .model-tag {
    font-size: 0.6rem; padding: 0.1rem 0.35rem; border-radius: 3px;
    background: rgba(34,197,94,0.1); color: var(--green);
  }
  .kb-chat-messages {
    flex: 1; overflow-y: auto; padding: 0.5rem;
    display: flex; flex-direction: column; gap: 0.4rem;
  }
  .kb-chat-welcome {
    color: var(--text-dim); font-size: 0.72rem; text-align: center;
    padding: 2rem 1rem; opacity: 0.5;
  }
  .kb-chat-msg {
    padding: 0.4rem 0.6rem; border-radius: 8px;
    font-size: 0.75rem; line-height: 1.5; word-break: break-word; max-width: 95%;
  }
  .kb-chat-msg.user {
    background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.15);
    align-self: flex-end; color: var(--accent); white-space: pre-wrap;
  }
  .kb-chat-msg.assistant {
    background: var(--surface2); border: 1px solid var(--border);
    align-self: flex-start; color: var(--text);
  }
  .kb-chat-msg.assistant code { background: var(--bg); padding: 0.1rem 0.25rem; border-radius: 3px; font-size: 0.7rem; }
  .kb-chat-msg.assistant pre { background: var(--bg); padding: 0.4rem 0.6rem; border-radius: 6px; margin: 0.3rem 0; overflow-x: auto; font-size: 0.68rem; }
  .kb-chat-msg.assistant pre code { background: none; padding: 0; }
  .kb-chat-msg.error {
    background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
    align-self: flex-start; color: var(--red); font-size: 0.72rem;
  }
  .kb-chat-msg.thinking {
    color: var(--text-dim); font-style: italic; font-size: 0.72rem;
    align-self: flex-start; animation: pulse 1.5s ease-in-out infinite;
    padding: 0.4rem 0.6rem;
  }
  .kb-chat-input-area {
    padding: 0.5rem; border-top: 1px solid var(--border);
    display: flex; gap: 0.3rem; flex-shrink: 0;
  }
  .kb-chat-input-area input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.4rem 0.6rem; color: var(--text); font-family: inherit; font-size: 0.75rem; outline: none;
  }
  .kb-chat-input-area input:focus { border-color: var(--accent); }
  .kb-chat-input-area input::placeholder { color: var(--text-dim); opacity: 0.5; }

  .header-btn { position: relative; cursor: pointer; padding: 0.3rem; background: none; border: none; }
  .header-btn svg { width: 18px; height: 18px; fill: none; stroke: var(--text-dim); stroke-width: 2; transition: stroke 0.15s; }
  .header-btn:hover svg { stroke: var(--accent); }
  .header-btn.active svg { stroke: var(--accent); }
  .badge-count {
    position: absolute; top: -4px; right: -4px;
    background: var(--red); color: white; font-size: 0.55rem; font-weight: 700;
    min-width: 15px; height: 15px; border-radius: 999px;
    display: flex; align-items: center; justify-content: center; padding: 0 3px;
  }
  .badge-count.hidden { display: none; }
  .badge-count.pulse { animation: pulse 1s ease-in-out infinite; }

  .status-badge {
    display: inline-flex; align-items: center; gap: 0.4rem;
    padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.7rem; font-weight: 500; white-space: nowrap;
  }
  .status-ok { background: rgba(34,197,94,0.15); color: var(--green); }
  .status-err { background: rgba(239,68,68,0.15); color: var(--red); }
  .dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
  .dot-ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .dot-err { background: var(--red); box-shadow: 0 0 6px var(--red); }

  /* === Health Bar === */
  .health-bar {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0.35rem 1.5rem; display: flex; gap: 1.5rem;
    font-size: 0.7rem; color: var(--text-dim); align-items: center; overflow-x: auto;
  }
  .health-item { display: flex; align-items: center; gap: 0.35rem; white-space: nowrap; }
  .health-item .value { color: var(--text); font-weight: 500; }
  .health-item .dot { width: 6px; height: 6px; }

  /* === Main Content === */
  .main-content { padding: 1.25rem 1.5rem; max-width: 1400px; margin: 0 auto; }

  /* === Slide-in Panels === */
  .slide-panel {
    position: fixed; top: 50px; right: 0; width: 66vw; max-width: 800px;
    height: calc(100vh - 50px); background: var(--surface);
    border-left: 1px solid var(--border); z-index: 60;
    transform: translateX(100%); transition: transform 0.25s ease;
    display: flex; flex-direction: column;
    box-shadow: -4px 0 24px rgba(0,0,0,0.3);
  }
  .slide-panel.open { transform: translateX(0); }
  .panel-header {
    padding: 0.75rem 1rem; border-bottom: 1px solid var(--border);
    font-weight: 600; font-size: 0.8rem; color: var(--text-dim);
    text-transform: uppercase; letter-spacing: 0.05em;
    display: flex; justify-content: space-between; align-items: center;
    flex-shrink: 0;
  }
  .panel-close { background: none; border: none; color: var(--text-dim); font-size: 1.2rem; cursor: pointer; padding: 0 0.25rem; }
  .panel-close:hover { color: var(--text); }
  .panel-tabs {
    display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .panel-tab {
    flex: 1; padding: 0.5rem 0.75rem; text-align: center; font-size: 0.72rem;
    font-weight: 500; color: var(--text-dim); cursor: pointer;
    border-bottom: 2px solid transparent; transition: all 0.15s;
    background: none; border-top: none; border-left: none; border-right: none;
  }
  .panel-tab:hover { color: var(--text); }
  .panel-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .panel-body { flex: 1; overflow-y: auto; }
  .panel-body-section { display: none; height: 100%; overflow-y: auto; }
  .panel-body-section.active { display: block; }

  /* Activity items */
  .activity-list { padding: 0.4rem; }
  .activity-item {
    padding: 0.5rem 0.6rem; border-bottom: 1px solid rgba(37,48,72,0.3);
    font-size: 0.72rem; line-height: 1.4;
  }
  .activity-item:last-child { border-bottom: none; }
  .activity-time { color: var(--text-dim); font-size: 0.62rem; display: block; margin-bottom: 0.15rem; }
  .activity-type {
    display: inline-block; padding: 0.05rem 0.3rem; border-radius: 3px;
    font-size: 0.6rem; font-weight: 600; margin-right: 0.3rem; text-transform: uppercase;
  }
  .activity-type.cron_run { background: rgba(0,212,255,0.15); color: var(--accent); }
  .activity-type.cron_toggle { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .activity-type.agent_message { background: rgba(124,58,237,0.15); color: var(--accent2); }
  .activity-type.system { background: rgba(122,139,168,0.15); color: var(--text-dim); }
  .activity-type.session { background: rgba(34,197,94,0.15); color: var(--green); }
  .activity-type.heartbeat { background: rgba(249,115,22,0.15); color: var(--orange); }
  .activity-empty { padding: 2rem 1rem; text-align: center; color: var(--text-dim); font-size: 0.78rem; }

  /* Gateway log items */
  .log-list { padding: 0.3rem; font-size: 0; }
  .log-line {
    font-size: 0.68rem; line-height: 1.5; padding: 0.1rem 0.5rem;
    font-family: 'SF Mono', 'Fira Code', monospace; white-space: pre-wrap;
    word-break: break-all; border-bottom: 1px solid rgba(37,48,72,0.15);
  }
  .log-line:hover { background: rgba(0,212,255,0.03); }
  .log-line .ts { color: var(--text-dim); font-size: 0.6rem; margin-right: 0.4rem; }
  .log-line.stderr { color: var(--yellow); }
  .log-line.stdout { color: var(--text); }
  .log-line .log-text { }
  .log-controls {
    padding: 0.4rem 0.6rem; border-bottom: 1px solid var(--border);
    display: flex; gap: 0.4rem; align-items: center; flex-shrink: 0;
  }
  .log-controls select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 4px;
    color: var(--text); font-family: inherit; font-size: 0.68rem; padding: 0.2rem 0.4rem;
  }
  .log-auto-label { font-size: 0.65rem; color: var(--text-dim); display: flex; align-items: center; gap: 0.25rem; }
  .log-auto-label input { accent-color: var(--accent); }

  /* === Section Headers === */
  .section { margin-bottom: 1.5rem; }
  h2 { font-size: 0.85rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 0.75rem; }
  .refresh-info { color: var(--text-dim); font-size: 0.65rem; }

  /* === Treasury === */
  .treasury-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 0.5rem; }
  .wallet-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 1rem; transition: border-color 0.2s;
  }
  .wallet-card:hover { border-color: var(--accent); }
  .wallet-header { display: flex; align-items: center; gap: 0.6rem; margin-bottom: 0.75rem; }
  .wallet-emoji { font-size: 1.5rem; }
  .wallet-name { font-weight: 600; font-size: 0.9rem; }
  .wallet-addr { font-size: 0.65rem; color: var(--text-dim); }
  .wallet-total { font-size: 1.4rem; font-weight: 700; color: var(--green); margin-bottom: 0.75rem; }
  .wallet-total .label { font-size: 0.65rem; color: var(--text-dim); font-weight: 400; display: block; }
  .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; }
  .balance-item { background: var(--surface2); border-radius: 8px; padding: 0.6rem; text-align: center; }
  .balance-amount { font-size: 1rem; font-weight: 600; }
  .balance-symbol { font-size: 0.65rem; color: var(--text-dim); margin-top: 0.1rem; }
  .balance-usd { font-size: 0.72rem; color: var(--green); margin-top: 0.15rem; }
  .treasury-total { text-align: right; font-size: 0.8rem; color: var(--text-dim); padding: 0.4rem 0; }
  .treasury-total strong { color: var(--green); font-size: 1rem; }

  /* === Compact Agent Cards === */
  .agent-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
  }
  .agent-compact {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 0.6rem 0.75rem; display: flex; align-items: center; gap: 0.5rem;
    cursor: pointer; transition: border-color 0.15s, background 0.15s;
    user-select: none;
  }
  .agent-compact:hover { border-color: var(--accent); background: var(--surface2); }
  .agent-compact .emoji { font-size: 1.25rem; flex-shrink: 0; }
  .agent-compact .info { flex: 1; min-width: 0; }
  .agent-compact .name { font-weight: 600; font-size: 0.78rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .agent-compact .id { font-size: 0.62rem; color: var(--text-dim); }
  .agent-compact .status-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .agent-compact .status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .agent-compact .status-dot.idle { background: var(--text-dim); opacity: 0.5; }
  .agent-compact .session-count {
    font-size: 0.58rem; color: var(--text-dim); background: var(--surface2);
    padding: 0.1rem 0.3rem; border-radius: 3px; flex-shrink: 0;
  }

  /* === Agent Detail Modal === */
  #agent-modal .modal-content { max-width: 580px; }
  .agent-detail-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
  .agent-detail-header .emoji { font-size: 2rem; }
  .agent-detail-header .name { font-weight: 700; font-size: 1.1rem; }
  .agent-detail-header .id { font-size: 0.72rem; color: var(--text-dim); }
  .agent-detail-session {
    font-size: 0.72rem; padding: 0.35rem 0.6rem; margin-bottom: 0.6rem;
    background: var(--surface2); border-radius: 6px; border-left: 3px solid var(--border);
  }
  .agent-detail-session.active { border-left-color: var(--green); }
  .agent-sessions-section { margin-bottom: 0.6rem; }
  .session-card {
    background: var(--surface2); border-radius: 6px; border-left: 3px solid var(--border);
    padding: 0.5rem 0.65rem; margin-bottom: 0.4rem; font-size: 0.72rem;
  }
  .session-card.active { border-left-color: var(--green); }
  .session-card-header {
    display: flex; align-items: center; gap: 0.35rem; margin-bottom: 0.25rem;
    font-weight: 500; color: var(--text);
  }
  .session-card-header .dot { width: 6px; height: 6px; flex-shrink: 0; }
  .session-topic {
    color: var(--text); font-size: 0.72rem; line-height: 1.4; margin-bottom: 0.2rem;
    overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  }
  .session-latest {
    color: var(--text-dim); font-size: 0.68rem; line-height: 1.35;
    overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
    margin-bottom: 0.2rem; font-style: italic;
  }
  .session-meta {
    font-size: 0.62rem; color: var(--text-dim); display: flex; gap: 0.5rem; flex-wrap: wrap;
  }
  .session-meta span { white-space: nowrap; }
  .sessions-more {
    font-size: 0.65rem; color: var(--text-dim); text-align: center;
    padding: 0.25rem; margin-bottom: 0.4rem;
  }
  .agent-detail-theme { color: var(--text-dim); font-size: 0.75rem; line-height: 1.5; margin-bottom: 0.6rem; }
  .agent-detail-tools { display: flex; flex-wrap: wrap; gap: 0.25rem; margin-bottom: 0.75rem; }

  .chat-area {
    max-height: 250px; overflow-y: auto; margin-bottom: 0.5rem;
    display: flex; flex-direction: column; gap: 0.3rem;
    scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    min-height: 40px; background: var(--bg); border-radius: 8px; padding: 0.5rem;
  }
  .chat-area:empty::before {
    content: 'No messages yet'; color: var(--text-dim); font-size: 0.7rem;
    display: block; text-align: center; padding: 0.5rem; opacity: 0.5;
  }
  .chat-msg {
    padding: 0.35rem 0.55rem; border-radius: 8px;
    font-size: 0.72rem; line-height: 1.4; max-width: 92%; word-break: break-word; white-space: pre-wrap;
  }
  .chat-msg.user {
    background: rgba(0,212,255,0.08); border: 1px solid rgba(0,212,255,0.15);
    align-self: flex-end; color: var(--accent);
  }
  .chat-msg.agent {
    background: var(--surface2); border: 1px solid var(--border);
    align-self: flex-start; color: var(--text);
  }
  .chat-msg.thinking {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--yellow); font-style: italic; animation: pulse 1.5s ease-in-out infinite;
  }
  .chat-msg.error {
    background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
    align-self: flex-start; color: var(--red);
  }
  .msg-form { display: flex; gap: 0.3rem; }
  .msg-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.4rem 0.6rem; color: var(--text); font-family: inherit; font-size: 0.75rem; outline: none;
  }
  .msg-input:focus { border-color: var(--accent); }
  .msg-input::placeholder { color: var(--text-dim); opacity: 0.5; }

  /* === Buttons === */
  .btn {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.65rem; color: var(--accent); font-family: inherit;
    font-size: 0.72rem; cursor: pointer; white-space: nowrap; transition: all 0.15s;
  }
  .btn:hover { background: rgba(0,212,255,0.1); border-color: var(--accent); }
  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-sm { padding: 0.2rem 0.5rem; font-size: 0.65rem; }
  .btn-green { color: var(--green); }
  .btn-green:hover { background: rgba(34,197,94,0.1); border-color: var(--green); }
  .btn-run.running { color: var(--yellow); border-color: var(--yellow); animation: pulse 1.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
  .tool-tag {
    background: var(--surface2); border: 1px solid var(--border); border-radius: 4px;
    padding: 0.1rem 0.4rem; font-size: 0.65rem; color: var(--text-dim);
  }

  /* === Toggle Switch === */
  .toggle { position: relative; display: inline-block; width: 34px; height: 18px; vertical-align: middle; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background: var(--surface2); border: 1px solid var(--border); border-radius: 18px; transition: 0.2s;
  }
  .toggle-slider:before {
    content: ""; position: absolute; width: 12px; height: 12px; left: 2px; bottom: 2px;
    background: var(--text-dim); border-radius: 50%; transition: 0.2s;
  }
  .toggle input:checked + .toggle-slider { background: rgba(34,197,94,0.2); border-color: var(--green); }
  .toggle input:checked + .toggle-slider:before { background: var(--green); transform: translateX(16px); }

  /* === Cron Table === */
  .cron-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
  th {
    text-align: left; color: var(--text-dim); font-weight: 500; padding: 0.5rem 0.65rem;
    border-bottom: 1px solid var(--border); font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em;
  }
  td { padding: 0.55rem 0.65rem; border-bottom: 1px solid rgba(37,48,72,0.4); vertical-align: middle; }
  tr:hover td { background: rgba(0,212,255,0.02); }
  .cron-status { display: inline-block; padding: 0.1rem 0.45rem; border-radius: 4px; font-size: 0.68rem; font-weight: 500; }
  .cron-ok { background: rgba(34,197,94,0.15); color: var(--green); }
  .cron-err { background: rgba(239,68,68,0.15); color: var(--red); }
  .cron-never { background: rgba(122,139,168,0.15); color: var(--text-dim); }
  .cron-disabled { background: rgba(122,139,168,0.1); color: var(--text-dim); opacity: 0.6; }
  .cron-actions { display: flex; gap: 0.3rem; align-items: center; }

  /* === Modals === */
  .modal {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7); z-index: 200; justify-content: center; align-items: center;
  }
  .modal.active { display: flex; }
  .modal-content {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    max-width: 750px; width: 92%; max-height: 80vh; overflow: hidden;
    display: flex; flex-direction: column; box-shadow: 0 12px 48px rgba(0,0,0,0.6);
  }
  .modal-header {
    padding: 0.85rem 1.25rem; border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; align-items: center;
  }
  .modal-header h3 { font-size: 0.95rem; font-weight: 600; }
  .modal-close { background: none; border: none; color: var(--text-dim); font-size: 1.4rem; cursor: pointer; padding: 0 0.25rem; line-height: 1; }
  .modal-close:hover { color: var(--text); }
  .modal-body { padding: 1rem 1.25rem; overflow-y: auto; flex: 1; }
  .modal-body table { font-size: 0.75rem; }
  .modal-body th { font-size: 0.65rem; }
  .modal-loading { text-align: center; padding: 2rem; color: var(--text-dim); }

  .tx-dir { font-weight: 600; font-size: 0.7rem; }
  .tx-dir.in { color: var(--green); }
  .tx-dir.out { color: var(--red); }
  .tx-hash { color: var(--accent); text-decoration: none; font-size: 0.68rem; }
  .tx-hash:hover { text-decoration: underline; }
  .tx-addr { font-size: 0.65rem; color: var(--text-dim); }
  .run-status { font-weight: 600; font-size: 0.7rem; }
  .run-status.ok { color: var(--green); }
  .run-status.error { color: var(--red); }
  .run-status.skipped { color: var(--yellow); }
  .run-summary { font-size: 0.7rem; color: var(--text-dim); max-width: 350px; white-space: pre-wrap; word-break: break-word; line-height: 1.4; }

  /* === Toasts === */
  .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 300; display: flex; flex-direction: column-reverse; gap: 0.5rem; }
  .toast {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 0.6rem 1rem; font-size: 0.75rem; box-shadow: 0 4px 24px rgba(0,0,0,0.5);
    transition: opacity 0.3s, transform 0.3s; opacity: 0; transform: translateX(20px); max-width: 350px;
  }
  .toast.show { opacity: 1; transform: translateX(0); }
  .toast.ok { border-left: 3px solid var(--green); }
  .toast.err { border-left: 3px solid var(--red); }
  .toast.info { border-left: 3px solid var(--accent); }

  /* === TODO Notepad === */
  .todo-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 1rem;
  }
  .todo-form { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; }
  .todo-form-extra { display: flex; gap: 0.4rem; margin-bottom: 0.75rem; }
  .todo-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.4rem 0.65rem; color: var(--text); font-family: inherit; font-size: 0.78rem; outline: none;
  }
  .todo-input:focus { border-color: var(--accent); }
  .todo-input::placeholder { color: var(--text-dim); opacity: 0.5; }
  .todo-desc-input {
    flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.4rem 0.65rem; color: var(--text); font-family: inherit; font-size: 0.72rem; outline: none;
    resize: none; min-height: 1.6rem;
  }
  .todo-desc-input:focus { border-color: var(--accent); }
  .todo-desc-input::placeholder { color: var(--text-dim); opacity: 0.5; }
  .todo-priority-select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.3rem 0.5rem; color: var(--text); font-family: inherit; font-size: 0.72rem;
    outline: none; cursor: pointer;
  }
  .todo-priority-select:focus { border-color: var(--accent); }
  .todo-list { list-style: none; }
  .todo-item {
    display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.55rem 0.3rem;
    border-bottom: 1px solid rgba(37,48,72,0.3); font-size: 0.78rem;
  }
  .todo-item:last-child { border-bottom: none; }
  .todo-priority-dot {
    width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; margin-top: 0.35rem;
  }
  .todo-priority-dot.high { background: var(--red); }
  .todo-priority-dot.medium { background: var(--yellow); }
  .todo-priority-dot.low { background: var(--text-dim); }
  .todo-content { flex: 1; min-width: 0; }
  .todo-title { word-break: break-word; line-height: 1.3; }
  .todo-title.completed { text-decoration: line-through; color: var(--text-dim); }
  .todo-description {
    font-size: 0.68rem; color: var(--text-dim); margin-top: 0.2rem;
    word-break: break-word; line-height: 1.25;
  }
  .todo-meta {
    display: flex; gap: 0.4rem; align-items: center; margin-top: 0.25rem;
    font-size: 0.6rem; color: var(--text-dim);
  }
  .todo-status {
    display: inline-block; padding: 0.05rem 0.35rem; border-radius: 4px;
    font-size: 0.58rem; font-weight: 600; text-transform: uppercase; cursor: pointer;
    user-select: none; flex-shrink: 0; white-space: nowrap;
  }
  .todo-status.pending { background: rgba(234,179,8,0.15); color: var(--yellow); }
  .todo-status.planning { background: rgba(168,85,247,0.15); color: #a855f7; }
  .todo-status.awaiting_approval { background: rgba(251,146,60,0.15); color: #fb923c; }
  .todo-status.executing { background: rgba(0,212,255,0.15); color: var(--accent); animation: pulse-status 1.5s ease-in-out infinite; }
  .todo-status.completed { background: rgba(34,197,94,0.15); color: var(--green); }
  .todo-status.failed { background: rgba(239,68,68,0.15); color: var(--red); }
  /* Legacy compat */
  .todo-status.in-progress { background: rgba(0,212,255,0.15); color: var(--accent); }
  .todo-status.done { background: rgba(34,197,94,0.15); color: var(--green); }
  @keyframes pulse-status {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .todo-toolbar {
    display: flex; gap: 0.4rem; align-items: center; margin-bottom: 0.6rem;
    flex-wrap: wrap;
  }
  .todo-filter-select {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 0.25rem 0.45rem; color: var(--text); font-family: inherit; font-size: 0.68rem;
    outline: none; cursor: pointer;
  }
  .todo-filter-select:focus { border-color: var(--accent); }
  .todo-toolbar-spacer { flex: 1; }
  .todo-toggle-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 0.2rem 0.5rem; color: var(--text-dim); font-family: inherit; font-size: 0.65rem;
    cursor: pointer; transition: color 0.15s, border-color 0.15s; white-space: nowrap;
  }
  .todo-toggle-btn:hover { color: var(--accent); border-color: var(--accent); }
  .todo-toggle-btn.active { color: var(--accent); border-color: var(--accent); }
  .todo-actions {
    display: flex; flex-direction: column; gap: 0.4rem; align-items: center; flex-shrink: 0;
    margin-top: 0.1rem;
  }
  .todo-delete {
    background: none; border: none; color: var(--text-dim); cursor: pointer;
    font-size: 0.85rem; padding: 0 0.2rem; opacity: 0.5; transition: opacity 0.15s;
  }
  .todo-delete:hover { opacity: 1; color: var(--red); }
  .todo-run {
    background: none; border: 1px solid var(--border); color: var(--accent); cursor: pointer;
    font-size: 0.58rem; font-weight: 600; font-family: inherit; padding: 0.15rem 0.4rem;
    border-radius: 4px; opacity: 0.7; transition: opacity 0.15s, border-color 0.15s;
    text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap;
  }
  .todo-run:hover { opacity: 1; border-color: var(--accent); }
  .todo-run:disabled { opacity: 0.3; cursor: default; }
  .todo-empty { padding: 1rem; text-align: center; color: var(--text-dim); font-size: 0.78rem; }

  /* === Responsive === */
  @media (max-width: 768px) {
    header { padding: 0.5rem 0.75rem; gap: 0.5rem; }
    .search-input { width: 140px; }
    .search-input:focus { width: 180px; }
    .main-content { padding: 0.75rem; }
    .agent-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    .treasury-grid { grid-template-columns: 1fr; }
    .health-bar { padding: 0.3rem 0.75rem; gap: 0.75rem; font-size: 0.65rem; }
    .slide-panel { width: 100%; }
    #kb-modal .modal-content { width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; }
    .kb-doc-container { flex-direction: column; }
    .kb-doc-panel { flex: none; border-right: none; border-bottom: 1px solid var(--border); max-height: 40vh; }
    .kb-chat-panel { flex: 1; }
    .kb-results-grid { grid-template-columns: 1fr; }
  }
  @media (max-width: 480px) {
    .search-container { display: none; }
    .balance-grid { grid-template-columns: 1fr; }
    .agent-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<header>
  <h1>OASIS <span>Dashboard</span></h1>
  <div class="header-spacer"></div>
  <div class="search-container">
    <span class="search-icon">&#128269;</span>
    <input class="search-input" id="curator-search" placeholder="Search Knowledge Base..." autocomplete="off" onfocus="openKB()">
  </div>
  <!-- Gateway Log button -->
  <button class="header-btn" id="logs-toggle" onclick="toggleLogs()" title="Gateway Logs">
    <svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
  </button>
  <!-- Activity Feed button -->
  <button class="header-btn" id="activity-toggle" onclick="toggleActivity()" title="Activity Feed">
    <svg viewBox="0 0 24 24"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
    <span class="badge-count hidden" id="notif-count">0</span>
  </button>
  <div id="health-badge" class="status-badge status-err"><span class="dot"></span> ...</div>
</header>

<div class="health-bar">
  <div class="health-item"><span class="label">Gateway</span> <span class="dot dot-err" id="hb-gw-dot"></span> <span class="value" id="hb-gw">--</span></div>
  <div class="health-item"><span class="label">Telegram</span> <span class="dot" id="hb-tg-dot"></span> <span class="value" id="hb-tg">--</span></div>
  <div class="health-item"><span class="label">Sessions</span> <span class="value" id="hb-sessions">--</span></div>
  <div class="health-item"><span class="label">Uptime</span> <span class="value" id="hb-uptime">--</span></div>
  <div class="health-item refresh-info">Auto-refresh 30s | <span id="last-update">--</span></div>
</div>

<!-- Activity Panel (slide-in from right) -->
<div class="slide-panel" id="activity-panel">
  <div class="panel-header">
    Activity Feed
    <button class="panel-close" onclick="toggleActivity()" title="Close">&times;</button>
  </div>
  <div class="panel-body">
    <div class="activity-list" id="activity-list">
      <div class="activity-empty">No activity yet</div>
    </div>
  </div>
</div>

<!-- Gateway Logs Panel (slide-in from right) -->
<div class="slide-panel" id="logs-panel">
  <div class="panel-header">
    Gateway Logs
    <button class="panel-close" onclick="toggleLogs()" title="Close">&times;</button>
  </div>
  <div class="log-controls">
    <select id="log-tail" onchange="refreshLogs()">
      <option value="100">100 lines</option>
      <option value="200" selected>200 lines</option>
      <option value="500">500 lines</option>
      <option value="1000">1000 lines</option>
    </select>
    <button class="btn btn-sm" onclick="refreshLogs()">Refresh</button>
    <label class="log-auto-label">
      <input type="checkbox" id="log-auto" checked> Auto (10s)
    </label>
    <label class="log-auto-label">
      <input type="checkbox" id="log-scroll" checked> Auto-scroll
    </label>
  </div>
  <div class="panel-body" id="logs-body">
    <div class="log-list" id="log-list">
      <div class="activity-empty">Open to load gateway logs</div>
    </div>
  </div>
</div>

<div class="main-content">

  <div class="section">
    <h2>Treasury</h2>
    <div class="treasury-grid" id="treasury-grid">
      <div class="wallet-card" style="text-align:center;color:var(--text-dim);padding:1.5rem">Loading...</div>
    </div>
    <div class="treasury-total" id="treasury-total"></div>
  </div>

  <div class="section">
    <h2>Agents</h2>
    <div class="agent-grid" id="agents-grid">
      <div class="agent-compact" style="justify-content:center;color:var(--text-dim);cursor:default">Loading...</div>
    </div>
  </div>

  <div class="section">
    <h2>Cron Jobs</h2>
    <div class="cron-card">
      <table>
        <thead><tr><th></th><th>Job</th><th>Agent</th><th>Schedule</th><th>Status</th><th>Last Run</th><th>Next Run</th><th>Errors</th><th></th></tr></thead>
        <tbody id="cron-body"><tr><td colspan="9" style="padding:1.5rem;text-align:center;color:var(--text-dim)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h2>TODO</h2>
    <div class="todo-card">
      <div class="todo-form">
        <input class="todo-input" id="todo-title" placeholder="Task title..." onkeydown="if(event.key==='Enter')addTodo()">
        <select class="todo-priority-select" id="todo-priority">
          <option value="medium">Med</option>
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
        <button class="btn" onclick="addTodo()">Add</button>
      </div>
      <div class="todo-form-extra">
        <textarea class="todo-desc-input" id="todo-desc" placeholder="Description (optional)..." rows="1"></textarea>
      </div>
      <div class="todo-toolbar">
        <select class="todo-filter-select" id="todo-filter-status" onchange="refreshTodos()">
          <option value="all">All statuses</option>
          <option value="pending">Pending</option>
          <option value="planning">Planning</option>
          <option value="awaiting_approval">Awaiting</option>
          <option value="executing">Running</option>
          <option value="failed">Failed</option>
          <option value="completed">Completed</option>
        </select>
        <select class="todo-filter-select" id="todo-filter-priority" onchange="refreshTodos()">
          <option value="all">All priorities</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
        <select class="todo-filter-select" id="todo-sort" onchange="refreshTodos()">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="priority">Priority</option>
          <option value="status">Status</option>
        </select>
        <span class="todo-toolbar-spacer"></span>
        <button class="todo-toggle-btn" id="todo-show-completed" onclick="toggleShowCompleted()">Show completed</button>
      </div>
      <ul class="todo-list" id="todo-list">
        <li class="todo-empty">No tasks</li>
      </ul>
    </div>
  </div>

</div>

<!-- Modals -->
<div class="modal" id="tx-modal">
  <div class="modal-content">
    <div class="modal-header"><h3 id="tx-modal-title">Transaction History</h3><button class="modal-close" onclick="closeModal('tx-modal')">&times;</button></div>
    <div class="modal-body">
      <table><thead><tr><th>Time</th><th>Dir</th><th>Amount</th><th>Token</th><th>Counterparty</th><th>Tx</th></tr></thead>
      <tbody id="tx-body"><tr><td colspan="6" class="modal-loading">Click "View Tx" on a wallet</td></tr></tbody></table>
    </div>
  </div>
</div>

<div class="modal" id="cron-modal">
  <div class="modal-content">
    <div class="modal-header"><h3 id="cron-modal-title">Cron Run History</h3><button class="modal-close" onclick="closeModal('cron-modal')">&times;</button></div>
    <div class="modal-body">
      <table><thead><tr><th>Time</th><th>Status</th><th>Duration</th><th>Summary</th></tr></thead>
      <tbody id="cron-history-body"><tr><td colspan="4" class="modal-loading">Click "History" on a cron job</td></tr></tbody></table>
    </div>
  </div>
</div>

<div class="modal" id="agent-modal">
  <div class="modal-content" style="max-width:580px">
    <div class="modal-header"><h3 id="agent-modal-title">Agent</h3><button class="modal-close" onclick="closeModal('agent-modal')">&times;</button></div>
    <div class="modal-body" id="agent-modal-body"></div>
  </div>
</div>

<div class="modal" id="kb-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="kb-title">Knowledge Base</h3>
      <button class="modal-close" onclick="closeKB()">&times;</button>
    </div>
    <div class="kb-search-row" id="kb-search-row">
      <button class="kb-back-btn" id="kb-back" onclick="kbBack()" style="display:none">&larr; Back</button>
      <input id="kb-input" placeholder="Search curator library..." autocomplete="off">
    </div>
    <div class="modal-body" id="kb-body" style="padding:0">
      <div id="kb-results">
        <div class="kb-empty">Type to search the Curator knowledge base<div class="hint">Searches library, transcripts, profiles, and logs</div></div>
      </div>
      <div id="kb-doc-view" style="display:none">
        <div class="kb-doc-container">
          <div class="kb-doc-panel" id="kb-doc-content"></div>
          <div class="kb-chat-panel">
            <div class="kb-chat-header">
              <span>Ask about this document</span>
              <span class="model-tag">Gemini 2.5 Flash</span>
            </div>
            <div class="kb-chat-messages" id="kb-chat-msgs">
              <div class="kb-chat-welcome">Ask a question about this document...</div>
            </div>
            <div class="kb-chat-input-area">
              <input id="kb-chat-input" placeholder="Ask about this document..." onkeydown="if(event.key==='Enter')kbSendChat()">
              <button class="btn" id="kb-chat-btn" onclick="kbSendChat()">Ask</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
// ========== State ==========
let sessionsByAgent = {};
let agentChats = {};
let agentsData = [];
let lastActivityCount = parseInt(localStorage.getItem('oasis_last_activity') || '0');
let notifCount = 0;
let activityOpen = false;
let logsOpen = false;
let openAgentId = null;
let logAutoTimer = null;

const $ = s => document.querySelector(s);

function timeAgo(iso) {
  if (!iso) return '--';
  const s = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
  if (s < 0) return 'just now';
  if (s < 60) return s + 's ago';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

function timeUntil(iso) {
  if (!iso) return '--';
  const s = Math.floor((new Date(iso).getTime() - Date.now()) / 1000);
  if (s < 0) return 'overdue';
  if (s < 60) return s + 's';
  if (s < 3600) return Math.floor(s / 60) + 'm';
  if (s < 86400) return Math.floor(s / 3600) + 'h';
  return Math.floor(s / 86400) + 'd';
}

function formatDuration(ms) {
  if (!ms) return '--';
  if (ms < 1000) return ms + 'ms';
  if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
  return (ms / 60000).toFixed(1) + 'm';
}

function formatUptime(secs) {
  if (!secs) return '--';
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function escapeHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function truncAddr(a) { return a ? a.slice(0,6)+'...'+a.slice(-4) : ''; }

async function fetchJSON(url, opts) {
  try { return await (await fetch(url, opts)).json(); } catch { return null; }
}

function showToast(msg, type = 'ok') {
  const c = $('#toast-container'), t = document.createElement('div');
  t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t);
  requestAnimationFrame(() => t.classList.add('show'));
  setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 4000);
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); if (id === 'agent-modal') openAgentId = null; }
document.addEventListener('click', e => { if (e.target.classList.contains('modal') && e.target.classList.contains('active')) { e.target.classList.remove('active'); if (e.target.id === 'agent-modal') openAgentId = null; }});

// ========== Activity Panel ==========
function toggleActivity() {
  activityOpen = !activityOpen;
  $('#activity-panel').classList.toggle('open', activityOpen);
  $('#activity-toggle').classList.toggle('active', activityOpen);
  // Close logs panel if opening activity
  if (activityOpen && logsOpen) { logsOpen = false; $('#logs-panel').classList.remove('open'); $('#logs-toggle').classList.remove('active'); stopLogAutoRefresh(); }
  if (activityOpen) { notifCount = 0; localStorage.setItem('oasis_last_activity', lastActivityCount.toString()); updateNotifBadge(); refreshActivity(); }
}

function updateNotifBadge() {
  const b = $('#notif-count');
  if (notifCount > 0) { b.textContent = notifCount > 99 ? '99+' : notifCount; b.className = 'badge-count pulse'; }
  else { b.className = 'badge-count hidden'; }
}

async function refreshActivity() {
  const data = await fetchJSON('/api/activity?limit=50');
  const list = $('#activity-list');
  const items = data?.activity || [];
  if (!items.length) { list.innerHTML = '<div class="activity-empty">Waiting for activity... The poller detects session changes, cron runs, and dashboard actions.</div>'; return; }
  list.innerHTML = items.map(a => {
    const time = new Date(a.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const agent = a.agent ? `<strong>${escapeHtml(a.agent)}</strong> \u2014 ` : '';
    return `<div class="activity-item"><span class="activity-time">${time}</span><span class="activity-type ${a.type}">${a.type.replace('_',' ')}</span>${agent}${escapeHtml(a.message)}</div>`;
  }).join('');
  if (items.length > lastActivityCount && !activityOpen) { notifCount += items.length - lastActivityCount; updateNotifBadge(); }
  lastActivityCount = items.length;
}

// ========== Gateway Logs Panel ==========
function toggleLogs() {
  logsOpen = !logsOpen;
  $('#logs-panel').classList.toggle('open', logsOpen);
  $('#logs-toggle').classList.toggle('active', logsOpen);
  // Close activity panel if opening logs
  if (logsOpen && activityOpen) { activityOpen = false; $('#activity-panel').classList.remove('open'); $('#activity-toggle').classList.remove('active'); }
  if (logsOpen) {
    refreshLogs();
    startLogAutoRefresh();
  } else {
    stopLogAutoRefresh();
  }
}

function startLogAutoRefresh() {
  stopLogAutoRefresh();
  if ($('#log-auto').checked) {
    logAutoTimer = setInterval(() => { if (logsOpen) refreshLogs(); }, 10_000);
  }
}

function stopLogAutoRefresh() {
  if (logAutoTimer) { clearInterval(logAutoTimer); logAutoTimer = null; }
}

$('#log-auto')?.addEventListener('change', () => {
  if ($('#log-auto').checked) startLogAutoRefresh();
  else stopLogAutoRefresh();
});

// Strip ANSI escape codes for clean display
function stripAnsi(str) {
  return str.replace(/\x1b\[[0-9;]*m/g, '');
}

function colorizeLogLine(text) {
  // Color based on content patterns
  const clean = stripAnsi(text);
  if (/\[error\]|error:|ERR|failed|FAIL/i.test(clean)) return 'color: var(--red)';
  if (/\[warn\]|warning:|WARN/i.test(clean)) return 'color: var(--yellow)';
  if (/\[gateway\]/i.test(clean)) return 'color: var(--accent)';
  if (/\[cron\]/i.test(clean)) return 'color: var(--orange)';
  if (/\[heartbeat\]|HEARTBEAT/i.test(clean)) return 'color: var(--text-dim)';
  if (/\[telegram\]|\[whatsapp\]/i.test(clean)) return 'color: #a78bfa';
  return '';
}

async function refreshLogs() {
  const tail = $('#log-tail').value || 200;
  const data = await fetchJSON(`/api/logs/gateway?tail=${tail}`);
  const container = $('#log-list');

  if (!data?.lines?.length) {
    container.innerHTML = '<div class="activity-empty">No logs available. Docker socket may not be mounted.</div>';
    return;
  }

  container.innerHTML = data.lines.map(l => {
    const clean = stripAnsi(l.text);
    // Try to extract timestamp from line
    const tsMatch = clean.match(/^(\d{4}-\d{2}-\d{2}T[\d:.]+Z?)\s*/);
    let ts = '';
    let text = clean;
    if (tsMatch) {
      try {
        ts = new Date(tsMatch[1]).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
      } catch { ts = ''; }
      text = clean.substring(tsMatch[0].length);
    }
    const style = colorizeLogLine(text);
    const streamClass = l.stream === 'stderr' ? 'stderr' : 'stdout';
    return `<div class="log-line ${streamClass}">${ts ? `<span class="ts">${ts}</span>` : ''}<span class="log-text"${style ? ` style="${style}"` : ''}>${escapeHtml(text)}</span></div>`;
  }).join('');

  // Auto-scroll to bottom
  if ($('#log-scroll').checked) {
    const body = $('#logs-body');
    body.scrollTop = body.scrollHeight;
  }
}

// ========== Treasury ==========
async function refreshTreasury() {
  const data = await fetchJSON('/api/treasury');
  if (!data?.wallets) return;
  $('#treasury-grid').innerHTML = Object.entries(data.wallets).map(([id, w]) => `
    <div class="wallet-card">
      <div class="wallet-header"><span class="wallet-emoji">${w.emoji}</span><div><div class="wallet-name">${escapeHtml(w.name)}</div><div class="wallet-addr">${truncAddr(w.address)}</div></div></div>
      <div class="wallet-total">$${w.totalUsd.toLocaleString('en-US',{minimumFractionDigits:2})}<span class="label">Total Value (USD)</span></div>
      <div class="balance-grid">
        <div class="balance-item"><div class="balance-amount">${w.eth.toFixed(4)}</div><div class="balance-symbol">ETH</div><div class="balance-usd">$${w.ethUsd.toFixed(2)}</div></div>
        <div class="balance-item"><div class="balance-amount">${w.usdc.toFixed(2)}</div><div class="balance-symbol">USDC</div><div class="balance-usd">$${w.usdc.toFixed(2)}</div></div>
      </div>
      <button class="btn btn-sm btn-green" onclick="showTxHistory('${w.address}','${escapeHtml(w.name)}')">View Transactions</button>
    </div>`).join('');
  $('#treasury-total').innerHTML = `ETH: <strong>$${data.ethPrice.toLocaleString()}</strong> | Total Treasury: <strong>$${data.totalUsd.toLocaleString('en-US',{minimumFractionDigits:2})}</strong>`;
}

async function showTxHistory(address, name) {
  $('#tx-modal-title').textContent = `Transaction History \u2014 ${name}`;
  $('#tx-body').innerHTML = '<tr><td colspan="6" class="modal-loading">Loading...</td></tr>';
  openModal('tx-modal');
  const data = await fetchJSON(`/api/treasury/${address}/transactions`);
  if (!data?.transactions?.length) { $('#tx-body').innerHTML = '<tr><td colspan="6" class="modal-loading">No transactions found</td></tr>'; return; }
  $('#tx-body').innerHTML = data.transactions.map(tx => `<tr>
    <td style="white-space:nowrap;font-size:0.7rem">${new Date(tx.timestamp).toLocaleDateString()} ${new Date(tx.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
    <td><span class="tx-dir ${tx.direction}">${tx.direction==='in'?'\u2b07 IN':'\u2b06 OUT'}</span></td>
    <td style="font-weight:600">${tx.value}</td><td>${escapeHtml(tx.symbol)}</td>
    <td><span class="tx-addr">${truncAddr(tx.direction==='in'?tx.from:tx.to)}</span></td>
    <td><a class="tx-hash" href="https://basescan.org/tx/${tx.hash}" target="_blank" rel="noopener">${truncAddr(tx.hash)}</a></td>
  </tr>`).join('');
}

// ========== Sessions ==========
async function refreshSessions() {
  const data = await fetchJSON('/api/sessions');
  sessionsByAgent = {};
  const sessions = data?.sessions || [];
  if (Array.isArray(sessions)) {
    for (const s of sessions) {
      const m = (s.key||'').match(/^agent:([^:]+)/);
      const aid = m ? m[1] : s.agentId;
      if (!aid) continue;
      if (!sessionsByAgent[aid]) sessionsByAgent[aid] = [];
      sessionsByAgent[aid].push(s);
    }
    for (const aid in sessionsByAgent) sessionsByAgent[aid].sort((a,b) => (b.updatedAt||0)-(a.updatedAt||0));
  }
  $('#hb-sessions').textContent = sessions.length;
}

function getSessionInfo(agentId) {
  const sessions = sessionsByAgent[agentId];
  if (!sessions?.length) return { active: false, text: 'No sessions', count: 0 };
  const s = sessions[0];
  const isActive = s.updatedAt && (Date.now() - s.updatedAt) < 300_000;
  const ago = s.updatedAt ? timeAgo(new Date(s.updatedAt).toISOString()) : '--';
  const ch = s.channel ? ` via ${s.channel}` : '';
  const extra = sessions.length > 1 ? ` (+${sessions.length-1})` : '';
  return { active: isActive, text: `${isActive?'Active':'Last'} ${ago}${ch}${extra}`, count: sessions.length };
}

// ========== Agents (Compact Cards) ==========
async function refreshAgents() {
  const data = await fetchJSON('/api/agents');
  if (!data?.agents?.length) { $('#agents-grid').innerHTML = '<div class="agent-compact" style="justify-content:center;color:var(--text-dim);cursor:default">No agents</div>'; return; }
  agentsData = data.agents;
  const grid = $('#agents-grid');
  grid.innerHTML = data.agents.map(a => {
    const si = getSessionInfo(a.id);
    return `<div class="agent-compact" onclick="openAgentDetail('${a.id}')">
      <span class="emoji">${a.emoji}</span>
      <div class="info"><div class="name">${escapeHtml(a.name)}</div><div class="id">${escapeHtml(a.id)}</div></div>
      ${si.count > 0 ? `<span class="session-count">${si.count}</span>` : ''}
      <span class="status-dot ${si.active ? 'active' : 'idle'}"></span>
    </div>`;
  }).join('');
}

function formatTokens(n) {
  if (!n) return '';
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'k';
  return String(n);
}

function renderSessionCards(agentId) {
  const sessions = sessionsByAgent[agentId];
  if (!sessions?.length) return '<div class="agent-detail-session"><span class="dot" style="background:var(--text-dim);width:6px;height:6px;margin-right:4px"></span>No sessions</div>';

  const maxShow = 3;
  const toShow = sessions.slice(0, maxShow);
  let html = '';

  for (const s of toShow) {
    const isActive = s.updatedAt && (Date.now() - s.updatedAt) < 300_000;
    const ago = s.updatedAt ? timeAgo(new Date(s.updatedAt).toISOString()) : '--';
    const ch = s.channel ? ` via ${s.channel}` : '';
    const label = s.label || '';
    const kind = s.kind ? ` [${s.kind}]` : '';

    // Header: status + time + channel
    const headerText = label || `${isActive ? 'Active' : 'Last'} ${ago}${ch}${kind}`;

    // Topic: derived title (first user message)
    const topic = s.derivedTitle || '';

    // Current work: last message preview
    const lastMsg = s.lastMessagePreview || s.lastMessage?.text || s.lastMessage?.content || '';
    const preview = typeof lastMsg === 'string' ? lastMsg.substring(0, 200) : '';

    // Meta: model + tokens
    const metaParts = [];
    if (s.model) metaParts.push(s.model);
    if (s.totalTokens) metaParts.push(formatTokens(s.totalTokens) + ' tokens');

    html += `<div class="session-card ${isActive ? 'active' : ''}">
      <div class="session-card-header">
        <span class="dot" style="background:${isActive ? 'var(--green)' : 'var(--text-dim)'};border-radius:50%"></span>
        ${escapeHtml(headerText)}
      </div>
      ${topic ? `<div class="session-topic">${escapeHtml(topic)}</div>` : ''}
      ${preview ? `<div class="session-latest">${escapeHtml(preview)}</div>` : ''}
      ${metaParts.length ? `<div class="session-meta">${metaParts.map(p => `<span>${escapeHtml(p)}</span>`).join('<span>\u00b7</span>')}</div>` : ''}
    </div>`;
  }

  if (sessions.length > maxShow) {
    html += `<div class="sessions-more">+${sessions.length - maxShow} more session${sessions.length - maxShow > 1 ? 's' : ''}</div>`;
  }

  return html;
}

function openAgentDetail(agentId) {
  const a = agentsData.find(x => x.id === agentId);
  if (!a) return;
  openAgentId = agentId;
  const chatHtml = (agentChats[agentId]||[]).map(m => `<div class="chat-msg ${m.role}">${escapeHtml(m.text)}</div>`).join('');

  $('#agent-modal-title').textContent = `${a.emoji} ${a.name}`;
  $('#agent-modal-body').innerHTML = `
    <div class="agent-detail-header">
      <span class="emoji" style="font-size:2.5rem">${a.emoji}</span>
      <div><div class="name" style="font-size:1.1rem;font-weight:700">${escapeHtml(a.name)}</div><div class="id" style="font-size:0.72rem;color:var(--text-dim)">${escapeHtml(a.id)}</div></div>
    </div>
    <div class="agent-sessions-section" id="agent-sessions-${agentId}">
      ${renderSessionCards(agentId)}
    </div>
    <div class="agent-detail-theme">${escapeHtml(a.theme)}</div>
    <div class="agent-detail-tools">${a.tools.map(t=>`<span class="tool-tag">${escapeHtml(t)}</span>`).join('')}</div>
    <div class="chat-area" id="chat-${agentId}">${chatHtml}</div>
    <div class="msg-form">
      <input class="msg-input" id="msg-${agentId}" placeholder="Message ${escapeHtml(a.name)}..." onkeydown="if(event.key==='Enter')sendAgentMessage('${agentId}')">
      <button class="btn" id="msg-btn-${agentId}" onclick="sendAgentMessage('${agentId}')">Send</button>
    </div>`;
  openModal('agent-modal');
  const chatEl = $(`#chat-${agentId}`);
  if (chatEl) chatEl.scrollTop = chatEl.scrollHeight;
  setTimeout(() => $(`#msg-${agentId}`)?.focus(), 100);
}

async function sendAgentMessage(agentId) {
  const input = $(`#msg-${agentId}`), btn = $(`#msg-btn-${agentId}`);
  const message = input?.value?.trim();
  if (!message) return;

  if (!agentChats[agentId]) agentChats[agentId] = [];
  agentChats[agentId].push({ role: 'user', text: message });
  agentChats[agentId].push({ role: 'thinking', text: 'Thinking...' });
  renderChat(agentId);
  input.value = '';
  btn.disabled = true; btn.textContent = 'Sending...';

  const data = await fetchJSON(`/api/agents/${agentId}/message`, {
    method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({message}),
  });

  agentChats[agentId] = agentChats[agentId].filter(m => m.role !== 'thinking');
  btn.disabled = false; btn.textContent = 'Send';

  if (data?.ok) {
    const txt = data.result?.text || data.result?.response || data.result?.content ||
      (typeof data.result === 'string' ? data.result : null) ||
      `Task sent (runId: ${(data.runId||'?').slice(0,8)}...)`;
    agentChats[agentId].push({ role: 'agent', text: txt });
    showToast(`${agentId} responded`, 'ok');
  } else {
    agentChats[agentId].push({ role: 'error', text: 'Error: '+(data?.error||'unknown') });
    showToast(`Failed to message ${agentId}`, 'err');
  }
  renderChat(agentId);
  setTimeout(refreshSessions, 3000);
}

function renderChat(agentId) {
  const el = $(`#chat-${agentId}`);
  if (!el) return;
  el.innerHTML = (agentChats[agentId]||[]).map(m => `<div class="chat-msg ${m.role}">${escapeHtml(m.text)}</div>`).join('');
  el.scrollTop = el.scrollHeight;
}

// ========== Cron ==========
async function refreshCron() {
  const data = await fetchJSON('/api/cron');
  const tbody = $('#cron-body');
  if (!data?.jobs?.length) { tbody.innerHTML = '<tr><td colspan="9" style="padding:1.5rem;text-align:center;color:var(--text-dim)">No cron jobs</td></tr>'; return; }
  tbody.innerHTML = data.jobs.map(j => {
    const cls = j.lastStatus==='ok'?'cron-ok':j.lastStatus==='never'?'cron-never':'cron-err';
    const statusCls = !j.enabled?'cron-disabled':cls;
    const dur = j.lastDurationMs?` (${formatDuration(j.lastDurationMs)})`:'';
    return `<tr style="${!j.enabled?'opacity:0.5':''}">
      <td><label class="toggle"><input type="checkbox" ${j.enabled?'checked':''} onchange="toggleCron('${j.id}',this)"><span class="toggle-slider"></span></label></td>
      <td><strong>${escapeHtml(j.name)}</strong><br><span style="color:var(--text-dim);font-size:0.68rem">${escapeHtml(j.id)}</span></td>
      <td>${escapeHtml(j.agentId)}</td>
      <td><code style="font-size:0.72rem">${escapeHtml(j.schedule)}</code><br><span style="color:var(--text-dim);font-size:0.65rem">${escapeHtml(j.tz)}</span></td>
      <td><span class="cron-status ${statusCls}">${!j.enabled?'disabled':j.lastStatus}</span></td>
      <td>${timeAgo(j.lastRunAt)}${dur}</td>
      <td>${j.enabled?timeUntil(j.nextRunAt):'--'}</td>
      <td style="color:${j.consecutiveErrors>0?'var(--red)':'var(--text-dim)'}">${j.consecutiveErrors}</td>
      <td><div class="cron-actions">
        <button class="btn btn-sm" onclick="runCronJob('${j.id}',this)" ${!j.enabled?'disabled':''}>Run</button>
        <button class="btn btn-sm" onclick="showCronHistory('${j.id}','${escapeHtml(j.name)}')">History</button>
      </div></td></tr>`;
  }).join('');
}

async function toggleCron(jobId, cb) {
  cb.disabled = true;
  const data = await fetchJSON(`/api/cron/${jobId}/toggle`,{method:'POST'});
  cb.disabled = false;
  if (data?.ok) { showToast(`${jobId} ${data.enabled?'enabled':'disabled'}`,'ok'); setTimeout(refreshCron,500); }
  else { cb.checked=!cb.checked; showToast(`Failed: ${data?.error||'unknown'}`,'err'); }
}

async function runCronJob(jobId, btn) {
  btn.disabled=true; btn.classList.add('running'); const orig=btn.textContent; btn.textContent='...';
  showToast(`Triggering ${jobId}...`,'info');
  const data = await fetchJSON(`/api/cron/${jobId}/run`,{method:'POST'});
  btn.classList.remove('running'); btn.disabled=false; btn.textContent=orig;
  if (data?.ok) { showToast(`${jobId} triggered`,'ok'); setTimeout(refreshCron,3000); }
  else showToast(`Failed: ${data?.error||'unknown'}`,'err');
}

async function showCronHistory(jobId, name) {
  $('#cron-modal-title').textContent = `Run History \u2014 ${name}`;
  $('#cron-history-body').innerHTML = '<tr><td colspan="4" class="modal-loading">Loading...</td></tr>';
  openModal('cron-modal');
  const data = await fetchJSON(`/api/cron/${jobId}/runs?limit=20`);
  const entries = data?.entries || [];
  if (!entries.length) { $('#cron-history-body').innerHTML = '<tr><td colspan="4" class="modal-loading">No run history</td></tr>'; return; }
  $('#cron-history-body').innerHTML = entries.map(e => `<tr>
    <td style="white-space:nowrap;font-size:0.7rem">${new Date(e.ts||e.runAtMs).toLocaleDateString()} ${new Date(e.ts||e.runAtMs).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</td>
    <td><span class="run-status ${e.status||'ok'}">${(e.status||'ok').toUpperCase()}</span></td>
    <td>${formatDuration(e.durationMs)}</td>
    <td><div class="run-summary">${escapeHtml((e.summary||e.error||'--').substring(0,500))}</div></td>
  </tr>`).join('');
}

// ========== Health ==========
async function refreshHealth() {
  const data = await fetchJSON('/api/system');
  const badge = $('#health-badge');
  if (data?.gateway?.ok) {
    badge.className='status-badge status-ok'; badge.innerHTML='<span class="dot dot-ok"></span> Online';
    $('#hb-gw').textContent='OK'; $('#hb-gw-dot').className='dot dot-ok';
  } else {
    badge.className='status-badge status-err'; badge.innerHTML='<span class="dot dot-err"></span> '+ escapeHtml(data?.error||'Offline');
    $('#hb-gw').textContent='Error'; $('#hb-gw-dot').className='dot dot-err';
  }
  const tg = data?.gateway?.channels?.telegram;
  if (tg) { const ok=tg.probe?.ok&&tg.configured; $('#hb-tg').textContent=ok?'OK':(tg.probe?.error||'Off'); $('#hb-tg-dot').className=ok?'dot dot-ok':'dot dot-err'; $('#hb-tg-dot').style.background=ok?'var(--green)':'var(--red)'; }
  if (data?.dashboard?.uptime) $('#hb-uptime').textContent = formatUptime(data.dashboard.uptime);
}

// ========== Knowledge Base ==========
let kbDocContent = '';
let kbDocPath = '';
let kbChatHistory = [];
let kbStreaming = false;
let kbSearchTimeout = null;
let kbAbortController = null;

function openKB() {
  $('#curator-search').blur();
  openModal('kb-modal');
  setTimeout(() => $('#kb-input').focus(), 100);
}

function closeKB() {
  closeModal('kb-modal');
  if (kbAbortController) { kbAbortController.abort(); kbAbortController = null; }
  kbStreaming = false;
}

$('#kb-input').addEventListener('input', e => {
  clearTimeout(kbSearchTimeout);
  const q = e.target.value.trim();
  if (q.length < 2) {
    $('#kb-results').innerHTML = '<div class="kb-empty">Type to search the Curator knowledge base<div class="hint">Searches library, transcripts, profiles, and logs</div></div>';
    return;
  }
  kbSearchTimeout = setTimeout(() => kbSearch(q), 300);
});

async function kbSearch(query) {
  const el = $('#kb-results');
  el.innerHTML = '<div class="kb-empty">Searching...</div>';
  const data = await fetchJSON(`/api/curator/search?q=${encodeURIComponent(query)}`);
  if (!data?.results?.length) {
    el.innerHTML = '<div class="kb-empty">No results found<div class="hint">Try different keywords</div></div>';
    return;
  }
  el.innerHTML = '<div class="kb-results-grid">' + data.results.map(r => {
    const cat = r.file.split('/')[0] || 'library';
    const fileName = r.file.split('/').pop();
    const snippet = r.matches?.[0]?.text || '';
    return `<div class="kb-result-card" onclick="kbOpenDoc('${escapeHtml(r.file).replace(/'/g, "\\'")}')">
      <span class="category ${cat}">${cat}</span>
      <div class="file-name">${escapeHtml(fileName)}</div>
      <div class="match-count">${r.totalMatches} match${r.totalMatches > 1 ? 'es' : ''} in ${escapeHtml(r.file)}</div>
      <div class="snippet">${escapeHtml(snippet)}</div>
    </div>`;
  }).join('') + '</div>';
}

async function kbOpenDoc(path) {
  kbDocPath = path;
  kbChatHistory = [];
  kbDocContent = '';

  $('#kb-results').style.display = 'none';
  $('#kb-doc-view').style.display = 'block';
  $('#kb-back').style.display = 'inline-block';
  $('#kb-input').style.display = 'none';
  $('#kb-title').textContent = path.split('/').pop();
  $('#kb-doc-content').innerHTML = '<div class="kb-empty">Loading document...</div>';
  $('#kb-chat-msgs').innerHTML = '<div class="kb-chat-welcome">Ask a question about this document...</div>';

  const data = await fetchJSON(`/api/curator/file?path=${encodeURIComponent(path)}`);
  if (!data?.content) {
    $('#kb-doc-content').innerHTML = '<div class="kb-empty">Failed to load document</div>';
    return;
  }

  kbDocContent = data.content;
  $('#kb-doc-content').innerHTML = renderMd(data.content);
  setTimeout(() => $('#kb-chat-input').focus(), 100);
}

function kbBack() {
  $('#kb-doc-view').style.display = 'none';
  $('#kb-results').style.display = 'block';
  $('#kb-back').style.display = 'none';
  $('#kb-input').style.display = 'block';
  $('#kb-title').textContent = 'Knowledge Base';
  if (kbAbortController) { kbAbortController.abort(); kbAbortController = null; }
  kbStreaming = false;
  kbDocContent = '';
  kbChatHistory = [];
  setTimeout(() => $('#kb-input').focus(), 50);
}

async function kbSendChat() {
  const input = $('#kb-chat-input');
  const message = input.value.trim();
  if (!message || kbStreaming) return;

  const msgsEl = $('#kb-chat-msgs');
  // Clear welcome message
  const welcome = msgsEl.querySelector('.kb-chat-welcome');
  if (welcome) welcome.remove();

  // Add user message
  const userEl = document.createElement('div');
  userEl.className = 'kb-chat-msg user';
  userEl.textContent = message;
  msgsEl.appendChild(userEl);

  input.value = '';
  kbStreaming = true;
  $('#kb-chat-btn').disabled = true;
  $('#kb-chat-btn').textContent = '...';

  // Add thinking indicator
  const thinkEl = document.createElement('div');
  thinkEl.className = 'kb-chat-msg thinking';
  thinkEl.textContent = 'Thinking...';
  msgsEl.appendChild(thinkEl);
  msgsEl.scrollTop = msgsEl.scrollHeight;

  try {
    kbAbortController = new AbortController();
    const response = await fetch('/api/curator/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, context: kbDocContent, history: kbChatHistory }),
      signal: kbAbortController.signal,
    });

    thinkEl.remove();

    const asstEl = document.createElement('div');
    asstEl.className = 'kb-chat-msg assistant';
    asstEl._raw = '';
    msgsEl.appendChild(asstEl);

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop();

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const data = line.slice(6).trim();
        if (!data) continue;
        try {
          const parsed = JSON.parse(data);
          if (parsed.type === 'token') {
            asstEl._raw += parsed.text;
            asstEl.innerHTML = renderMd(asstEl._raw);
            msgsEl.scrollTop = msgsEl.scrollHeight;
          } else if (parsed.type === 'error') {
            asstEl.className = 'kb-chat-msg error';
            asstEl.textContent = parsed.text;
          }
        } catch {}
      }
    }

    kbChatHistory.push({ role: 'user', text: message });
    kbChatHistory.push({ role: 'assistant', text: asstEl._raw || '' });
    if (kbChatHistory.length > 20) kbChatHistory = kbChatHistory.slice(-20);

  } catch (err) {
    thinkEl.remove();
    if (err.name !== 'AbortError') {
      const errEl = document.createElement('div');
      errEl.className = 'kb-chat-msg error';
      errEl.textContent = 'Error: ' + err.message;
      msgsEl.appendChild(errEl);
    }
  }

  kbStreaming = false;
  kbAbortController = null;
  $('#kb-chat-btn').disabled = false;
  $('#kb-chat-btn').textContent = 'Ask';
  msgsEl.scrollTop = msgsEl.scrollHeight;
}

// Simple markdown renderer
function renderMd(text) {
  const lines = text.split('\n');
  let html = '';
  let inCode = false;
  let inList = false;
  for (const line of lines) {
    if (line.startsWith('```')) {
      if (inCode) { html += '</code></pre>'; inCode = false; }
      else { if (inList) { html += '</ul>'; inList = false; } html += '<pre><code>'; inCode = true; }
      continue;
    }
    if (inCode) { html += escapeHtml(line) + '\n'; continue; }
    let s = escapeHtml(line);
    s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
    s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
    s = s.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    if (/^#{1,6} /.test(line)) {
      if (inList) { html += '</ul>'; inList = false; }
      const lvl = line.match(/^(#{1,6})/)[1].length;
      html += `<h${lvl}>${s.replace(/^#{1,6} /, '')}</h${lvl}>`;
    } else if (line.startsWith('> ')) {
      if (inList) { html += '</ul>'; inList = false; }
      html += `<blockquote>${s.replace(/^&gt; /, '')}</blockquote>`;
    } else if (line === '---' || line === '***') {
      if (inList) { html += '</ul>'; inList = false; }
      html += '<hr>';
    } else if (/^[-*] /.test(line)) {
      if (!inList) { html += '<ul>'; inList = true; }
      html += `<li>${s.replace(/^[-*] /, '')}</li>`;
    } else if (/^\d+\. /.test(line)) {
      if (!inList) { html += '<ul>'; inList = true; }
      html += `<li>${s.replace(/^\d+\. /, '')}</li>`;
    } else if (line.trim() === '') {
      if (inList) { html += '</ul>'; inList = false; }
    } else {
      if (inList) { html += '</ul>'; inList = false; }
      html += `<p>${s}</p>`;
    }
  }
  if (inCode) html += '</code></pre>';
  if (inList) html += '</ul>';
  return html;
}

// ========== TODO ==========
const TODO_STATUS_CYCLE = {
  'pending': 'awaiting_approval',
  'planning': 'pending',
  'awaiting_approval': 'completed',
  'executing': 'executing', // no manual cycle
  'completed': 'pending',
  'failed': 'pending',
  // legacy
  'in-progress': 'done',
  'done': 'pending',
};

const TODO_STATUS_LABEL = {
  'pending': 'pending',
  'planning': 'planning',
  'awaiting_approval': 'awaiting',
  'executing': 'running',
  'completed': 'done',
  'failed': 'failed',
  'in-progress': 'in-progress',
  'done': 'done',
};

const TODO_PRIORITY_ORDER = { high: 0, medium: 1, low: 2 };
const TODO_STATUS_ORDER = { executing: 0, planning: 1, awaiting_approval: 2, pending: 3, failed: 4, completed: 5, done: 5, 'in-progress': 1 };

let todoShowCompleted = false;

function toggleShowCompleted() {
  todoShowCompleted = !todoShowCompleted;
  const btn = $('#todo-show-completed');
  btn.classList.toggle('active', todoShowCompleted);
  btn.textContent = todoShowCompleted ? 'Hide completed' : 'Show completed';
  refreshTodos();
}

function formatTodoDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  if (isNaN(d)) return '';
  const now = new Date();
  const diff = now - d;
  if (diff < 86400000) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  if (diff < 604800000) return d.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
  return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

async function refreshTodos() {
  const data = await fetchJSON('/api/todos');
  const list = $('#todo-list');
  let todos = data?.todos || [];
  if (!todos.length) { list.innerHTML = '<li class="todo-empty">No tasks  add one above</li>'; return; }

  // Filter: hide completed unless toggled
  if (!todoShowCompleted) {
    todos = todos.filter(t => t.status !== 'completed' && t.status !== 'done');
  }

  // Filter by status
  const statusFilter = $('#todo-filter-status')?.value || 'all';
  if (statusFilter !== 'all') {
    todos = todos.filter(t => t.status === statusFilter);
  }

  // Filter by priority
  const priorityFilter = $('#todo-filter-priority')?.value || 'all';
  if (priorityFilter !== 'all') {
    todos = todos.filter(t => (t.priority || 'medium') === priorityFilter);
  }

  // Sort
  const sort = $('#todo-sort')?.value || 'newest';
  if (sort === 'newest') {
    todos.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
  } else if (sort === 'oldest') {
    todos.sort((a, b) => new Date(a.created_at || 0) - new Date(b.created_at || 0));
  } else if (sort === 'priority') {
    todos.sort((a, b) => (TODO_PRIORITY_ORDER[a.priority] ?? 1) - (TODO_PRIORITY_ORDER[b.priority] ?? 1));
  } else if (sort === 'status') {
    todos.sort((a, b) => (TODO_STATUS_ORDER[a.status] ?? 3) - (TODO_STATUS_ORDER[b.status] ?? 3));
  }

  if (!todos.length) { list.innerHTML = '<li class="todo-empty">No matching tasks</li>'; return; }

  list.innerHTML = todos.map(t => {
    const statusCls = (t.status || 'pending').replace(/_/g, '_');
    const nextStatus = TODO_STATUS_CYCLE[t.status] || 'pending';
    const label = TODO_STATUS_LABEL[t.status] || t.status;
    const isClickable = t.status !== 'executing';
    const title = escapeHtml(t.title || t.text || 'Untitled');
    const desc = t.description ? `<div class="todo-description">${escapeHtml(t.description)}</div>` : '';
    const priority = t.priority || 'medium';
    const dateStr = formatTodoDate(t.created_at || t.createdAt);
    const completedDone = (t.status === 'completed' || t.status === 'done');
    return `<li class="todo-item">
      <span class="todo-priority-dot ${priority}"></span>
      <div class="todo-content">
        <div class="todo-title ${completedDone ? 'completed' : ''}">${title}</div>
        ${desc}
        <div class="todo-meta">
          <span class="todo-status ${statusCls}" ${isClickable ? `onclick="cycleTodoStatus('${t.id}','${nextStatus}')" title="Click to cycle"` : 'title="Automated  cannot change"'} style="${isClickable ? 'cursor:pointer' : 'cursor:default'}">${label}</span>
          ${dateStr ? `<span>${dateStr}</span>` : ''}
        </div>
      </div>
      <div class="todo-actions">
        ${t.status === 'pending' ? `<button class="todo-run" onclick="runTodoNow('${t.id}',this)" title="Run now (skip cron)">Run</button>` : ''}
        <button class="todo-delete" onclick="deleteTodo('${t.id}')" title="Delete">&times;</button>
      </div>
    </li>`;
  }).join('');
}

async function addTodo() {
  const titleInput = $('#todo-title');
  const descInput = $('#todo-desc');
  const prioritySelect = $('#todo-priority');
  const title = titleInput.value.trim();
  if (!title) return;
  const body = { title, priority: prioritySelect.value };
  const desc = descInput.value.trim();
  if (desc) body.description = desc;
  titleInput.value = '';
  descInput.value = '';
  prioritySelect.value = 'medium';
  const data = await fetchJSON('/api/todos', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (data?.ok) { showToast('Task added', 'ok'); refreshTodos(); }
  else showToast('Failed to add task', 'err');
}

async function cycleTodoStatus(id, newStatus) {
  await fetchJSON(`/api/todos/${id}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ status: newStatus }) });
  refreshTodos();
}

async function deleteTodo(id) {
  await fetchJSON(`/api/todos/${id}`, { method: 'DELETE' });
  refreshTodos();
}

async function runTodoNow(id, btn) {
  if (btn) { btn.disabled = true; btn.textContent = '...'; }
  const data = await fetchJSON(`/api/todos/${id}/run`, { method: 'POST' });
  if (data?.ok) {
    showToast('Queued for planning', 'ok');
  } else {
    showToast(data?.error || 'Failed to queue', 'err');
  }
  refreshTodos();
}

// ========== Refresh ==========
async function refresh() {
  await Promise.all([refreshHealth(), refreshSessions()]);
  await Promise.all([refreshAgents(), refreshCron(), refreshTreasury(), refreshActivity(), refreshTodos()]);
  // Re-render open agent modal session details if it's showing
  if (openAgentId && document.getElementById('agent-modal').classList.contains('active')) {
    const sessionsEl = $(`#agent-sessions-${openAgentId}`);
    if (sessionsEl) {
      sessionsEl.innerHTML = renderSessionCards(openAgentId);
    }
  }
  $('#last-update').textContent = new Date().toLocaleTimeString();
}

refresh();
setInterval(refresh, 30_000);
setInterval(refreshActivity, 10_000);
</script>
</body>
</html>
