networks:
  openclaw:
    driver: bridge

services:
  # --- Docker Socket Proxy ---
  # Restricts Docker API access for the dashboard container.
  # Container list/inspect/logs (GET) + stop/start/restart (POST) are permitted.
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-proxy
    networks:
      - openclaw
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      TZ: America/New_York
      CONTAINERS: 1
      POST: 1
      IMAGES: 0
      VOLUMES: 0
      NETWORKS: 0
      EXEC: 0
      BUILD: 0
      COMMIT: 0
      SWARM: 0
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- OpenClaw Gateway ---
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: oasis
    networks:
      - openclaw
    env_file: .env
    environment:
      TZ: America/New_York
      HOME: /home/node
      SHELL: /usr/bin/bash
      TERM: xterm-256color
      JITI_CACHE: "false"
      NODE_OPTIONS: "--max-old-space-size=3072"
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
      - ./dist:/app/dist:ro
      - ./extensions/voice-call/src/manager.ts:/app/extensions/voice-call/src/manager.ts:ro
      - ./extensions/voice-call/src/webhook.ts:/app/extensions/voice-call/src/webhook.ts:ro
      - ./extensions/voice-call/src/providers/telnyx.ts:/app/extensions/voice-call/src/providers/telnyx.ts:ro
      - ./extensions/voice-call/src/response-generator.ts:/app/extensions/voice-call/src/response-generator.ts:ro
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "127.0.0.1:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
      - "127.0.0.1:3334:3334"
    init: true
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4g
          cpus: "2.0"
          pids: 256
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "require(''net'').createConnection(18789,''127.0.0.1'').on(''connect'',()=>process.exit(0)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  # --- OASIS Dashboard ---
  oasis-dashboard:
    build:
      context: ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard
    container_name: oasis-dashboard
    user: "1000:1000"
    networks:
      - openclaw
    environment:
      TZ: America/New_York
      GATEWAY_URL: ws://oasis:18789
      DASHBOARD_PORT: 3000
      OPENCLAW_CONFIG_DIR: /config
      DOCKER_HOST: http://docker-proxy:2375
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      OPENCLAW_DASHBOARD_USERNAME: ${OPENCLAW_DASHBOARD_USERNAME:-}
      OPENCLAW_DASHBOARD_PASSWORD: ${OPENCLAW_DASHBOARD_PASSWORD:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      AUDIO_DONE_DIR: /audio/done
      AUDIO_INBOX_DIR: /audio/inbox
      AUDIO_LISTENER_URL: http://audio-listener:9001
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/config
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/server.js:/app/server.js:ro
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/server:/app/server:ro
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/public:/app/public:ro
      - ~/oasis-audio/done:/audio/done:ro
      - ~/oasis-audio/inbox:/audio/inbox:ro
      - ~/oasis-audio/playback:/audio/playback:ro
      - ~/oasis-audio/jobs.json:/audio/jobs.json:ro
    command: ["node", "server.js"]
    ports:
      - "3000:3000"
    depends_on:
      openclaw-gateway:
        condition: service_healthy
      docker-socket-proxy:
        condition: service_started
    restart: unless-stopped
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "0.5"
          pids: 128
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- Audio Listener (VAD + AssemblyAI Transcription + Speaker ID) ---
  # Path mapping (Docker → Host):
  #   /audio/inbox        → ~/oasis-audio/inbox         WAV files awaiting transcription
  #   /audio/done         → ~/oasis-audio/done          Transcript JSONs + .synced markers
  #   /voice-profiles     → ~/.openclaw/voice-profiles   Enrolled speaker embedding profiles
  #   /unknown-speakers   → ~/.openclaw/unknown-speakers  Candidate speaker data from clustering
  #   /app/*.py           → ./audio-listener/*.py        Source code (read-only bind mounts)
  audio-listener:
    build:
      context: ./audio-listener
      dockerfile: Dockerfile
    container_name: audio-listener
    networks:
      - openclaw
    restart: unless-stopped
    ports:
      - "127.0.0.1:9001:9001"
    env_file: .env
    volumes:
      - ~/oasis-audio/inbox:/audio/inbox
      - ~/oasis-audio/done:/audio/done
      - ~/.openclaw/voice-profiles:/voice-profiles
      - ~/.openclaw/unknown-speakers:/unknown-speakers
      - ./audio-listener/app.py:/app/app.py:ro
      - ./audio-listener/speaker_verify.py:/app/speaker_verify.py:ro
      - ./audio-listener/assemblyai_transcriber.py:/app/assemblyai_transcriber.py:ro
    environment:
      TZ: America/New_York
      SAMPLE_RATE: "16000"
      VAD_AGGRESSIVENESS: "3"
      MIN_SPEECH_SECONDS: "1.5"
      MAX_SEGMENT_SECONDS: "1800"
      SILENCE_TIMEOUT: "4.0"
      SILENCE_TIMEOUT_MIN: "3.0"
      SILENCE_TIMEOUT_MAX: "8.0"
      SILENCE_GROW_AFTER_SECONDS: "30"
      OUTPUT_DIR: /audio/inbox
      HEALTH_PORT: "9001"
      PULSE_SERVER: tcp:host.docker.internal:4713
      OPENCLAW_GATEWAY_URL: http://oasis:18789
      TRANSCRIPT_WATCH_DIR: /audio/done
      VERIFY_SPEAKER: "true"
      VOICE_PROFILES_DIR: /voice-profiles
      UNKNOWN_SPEAKERS_DIR: /unknown-speakers
      SPEAKER_ID_ENABLED: "true"
      NOISE_GATE_RMS: "0.03"
      QUIET_HOURS: "23-06"
      AUDIO_RETENTION_DAYS: "30"
      MIN_TRANSCRIBE_SECONDS: "10"
      VOICE_COMMAND_ALLOWED_SPEAKERS: "fred"
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 6144m
        reservations:
          cpus: "0.1"
          memory: 512m
    cpu_shares: 256
    oom_score_adj: 500
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- CLI (on-demand) ---
  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: oasis-cli
    profiles:
      - cli
    networks:
      - openclaw
    env_file: .env
    environment:
      TZ: America/New_York
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    entrypoint: ["node", "dist/index.js"]
    stdin_open: true
    tty: true
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
