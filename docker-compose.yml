networks:
  openclaw:
    driver: bridge

volumes:
  whisperx-cache:

services:
  # --- Docker Socket Proxy ---
  # Restricts Docker API access for the dashboard container.
  # Only container list/inspect/logs are permitted (GET-only).
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy
    container_name: docker-proxy
    networks:
      - openclaw
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      CONTAINERS: 1
      POST: 0
      IMAGES: 0
      VOLUMES: 0
      NETWORKS: 0
      EXEC: 0
      BUILD: 0
      COMMIT: 0
      SWARM: 0
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- OpenClaw Gateway ---
  openclaw-gateway:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: oasis
    networks:
      - openclaw
    env_file: .env
    environment:
      HOME: /home/node
      SHELL: /usr/bin/bash
      TERM: xterm-256color
      JITI_CACHE: "false"
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
      - ./dist:/app/dist:ro
      - ./extensions/voice-call/src/manager.ts:/app/extensions/voice-call/src/manager.ts:ro
      - ./extensions/voice-call/src/webhook.ts:/app/extensions/voice-call/src/webhook.ts:ro
      - ./extensions/voice-call/src/providers/telnyx.ts:/app/extensions/voice-call/src/providers/telnyx.ts:ro
      - ./extensions/voice-call/src/response-generator.ts:/app/extensions/voice-call/src/response-generator.ts:ro
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "127.0.0.1:${OPENCLAW_BRIDGE_PORT:-18790}:18790"
      - "127.0.0.1:3334:3334"
    init: true
    restart: unless-stopped
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 3g
          cpus: "2.0"
          pids: 256
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'node -e "require(''net'').createConnection(18789,''127.0.0.1'').on(''connect'',()=>process.exit(0)).on(''error'',()=>process.exit(1))"',
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  # --- OASIS Dashboard ---
  oasis-dashboard:
    build:
      context: ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard
    container_name: oasis-dashboard
    user: "1000:1000"
    networks:
      - openclaw
    environment:
      GATEWAY_URL: ws://oasis:18789
      DASHBOARD_PORT: 3000
      OPENCLAW_CONFIG_DIR: /config
      DOCKER_HOST: http://docker-proxy:2375
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      OPENCLAW_DASHBOARD_USERNAME: ${OPENCLAW_DASHBOARD_USERNAME:-}
      OPENCLAW_DASHBOARD_PASSWORD: ${OPENCLAW_DASHBOARD_PASSWORD:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      AUDIO_DONE_DIR: /audio/done
      AUDIO_INBOX_DIR: /audio/inbox
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/config
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/server.js:/app/server.js:ro
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/server:/app/server:ro
      - ${OPENCLAW_CONFIG_DIR}/workspace-oasis/dashboard/public:/app/public:ro
      - ~/oasis-audio/done:/audio/done:ro
      - ~/oasis-audio/inbox:/audio/inbox:ro
    command: ["node", "server.js"]
    ports:
      - "3000:3000"
    depends_on:
      openclaw-gateway:
        condition: service_healthy
      docker-socket-proxy:
        condition: service_started
    restart: unless-stopped
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: "0.5"
          pids: 128
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- Transcriber (Fast Transcription + Alignment, No Diarization) ---
  transcriber:
    build:
      context: ./transcriber-service
      dockerfile: Dockerfile
    container_name: transcriber
    networks:
      openclaw:
        aliases:
          - whisperx # backward compat for audio-listener WHISPERX_API_URL
    restart: unless-stopped
    ports:
      - "127.0.0.1:9000:9000"
    volumes:
      - whisperx-cache:/root/.cache
      - ~/oasis-audio/inbox:/audio/inbox
      - ~/oasis-audio/done:/audio/done
      - ./transcriber-service/app.py:/app/app.py:ro
    env_file: .env
    environment:
      WHISPER_MODEL: small
      DEVICE: cpu
      COMPUTE_TYPE: int8
      BATCH_SIZE: "4"
      API_PORT: "9000"
      WATCH_FOLDER: /audio/inbox
      OUTPUT_FOLDER: /audio/done
      WATCH_INTERVAL: "5"
      OUTPUT_FORMAT: json
      WHISPER_LANGUAGE: en
      VAD_ONSET: "0.200"
      VAD_OFFSET: "0.150"
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1536m
        reservations:
          cpus: "0.25"
          memory: 512m
    cpu_shares: 512
    oom_score_adj: 400
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 120s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- Diarizer (Async Speaker Identification via pyannote.audio) ---
  diarizer:
    build:
      context: ./diarizer-service
      dockerfile: Dockerfile
    container_name: diarizer
    networks:
      - openclaw
    restart: unless-stopped
    ports:
      - "127.0.0.1:9002:9002"
    volumes:
      - whisperx-cache:/root/.cache
      - ~/oasis-audio/inbox:/audio/inbox:ro
      - ~/oasis-audio/done:/audio/done
      - ./diarizer-service/app.py:/app/app.py:ro
      - ./diarizer-service/speaker_identify.py:/app/speaker_identify.py:ro
      - ~/.openclaw/voice-profiles:/voice-profiles:ro
      - ~/.openclaw/unknown-speakers:/unknown-speakers
    env_file: .env
    environment:
      API_PORT: "9002"
      DEVICE: cpu
      TRANSCRIPT_DIR: /audio/done
      AUDIO_DIR: /audio/inbox
      WATCH_INTERVAL: "10"
      VOICE_PROFILES_DIR: /voice-profiles
      UNKNOWN_SPEAKERS_DIR: /unknown-speakers
      SPEAKER_ID_ENABLED: "true"
    depends_on:
      transcriber:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 3g
        reservations:
          cpus: "0.1"
          memory: 512m
    cpu_shares: 128
    oom_score_adj: 600
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9002/health"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 180s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- Audio Listener (VAD + Voice Command Dispatch) ---
  audio-listener:
    build:
      context: ./audio-listener
      dockerfile: Dockerfile
    container_name: audio-listener
    networks:
      - openclaw
    restart: unless-stopped
    ports:
      - "127.0.0.1:9001:9001"
    env_file: .env
    volumes:
      - ~/oasis-audio/inbox:/audio/inbox
      - ~/oasis-audio/done:/audio/done
      - /tmp/pulseaudio.socket:/tmp/pulseaudio.socket
      - ~/.config/pulse/cookie:/root/.config/pulse/cookie:ro
      - ~/.openclaw/voice-profiles:/voice-profiles:ro
    environment:
      SAMPLE_RATE: "16000"
      VAD_AGGRESSIVENESS: "3"
      MIN_SPEECH_SECONDS: "1.5"
      MAX_SEGMENT_SECONDS: "1800"
      SILENCE_TIMEOUT: "4.0"
      SILENCE_TIMEOUT_MIN: "3.0"
      SILENCE_TIMEOUT_MAX: "8.0"
      SILENCE_GROW_AFTER_SECONDS: "30"
      OUTPUT_DIR: /audio/inbox
      HEALTH_PORT: "9001"
      PULSE_SERVER: tcp:host.docker.internal:4713
      OPENCLAW_GATEWAY_URL: http://oasis:18789
      TRANSCRIPT_WATCH_DIR: /audio/done
      TRANSCRIPT_POLL_INTERVAL: "2"
      WHISPERX_API_URL: "http://whisperx:9000"
      FAST_PATH_MAX_SECONDS: "60"
      FAST_PATH_DIARIZE: "false"
      VERIFY_SPEAKER: "true"
      VOICE_PROFILES_DIR: /voice-profiles
      AUDIO_GAIN_DB: "6"
      NOISE_GATE_RMS: "0.03"
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1536m
        reservations:
          cpus: "0.1"
          memory: 256m
    cpu_shares: 256
    oom_score_adj: 500
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # --- CLI (on-demand) ---
  openclaw-cli:
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: oasis-cli
    profiles:
      - cli
    networks:
      - openclaw
    env_file: .env
    environment:
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
    volumes:
      - ${OPENCLAW_CONFIG_DIR}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR}:/home/node/.openclaw/workspace
    entrypoint: ["node", "dist/index.js"]
    stdin_open: true
    tty: true
    init: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
